
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">



  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
  <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1" media="(device-height: 568px)">
  <meta name="selected-link" value="repo_source">

      <meta name="google-analytics" content="UA-3769691-2">

<meta content="collector.githubapp.com" name="octolytics-host" /><meta content="github" name="octolytics-app-id" /><meta content="https://collector.githubapp.com/github-external/browser_event" name="octolytics-event-url" /><meta content="CE15:5BD3:8F64CC:E733DB:58A70F6A" name="octolytics-dimension-request_id" /><meta content="25846784" name="octolytics-actor-id" /><meta content="Dialistar" name="octolytics-actor-login" /><meta content="54ba2e81f7599ac4511eb8de370b8e2d5839ab0e411756386fd798db1810a123" name="octolytics-actor-hash" />
<meta content="mobile" name="octolytics-dimension-device" />
<meta content="15281352" name="octolytics-dimension-user_id" /><meta content="iuncuim" name="octolytics-dimension-user_login" /><meta content="62134271" name="octolytics-dimension-repository_id" /><meta content="iuncuim/KK_kernel_lenovo_a369i" name="octolytics-dimension-repository_nwo" /><meta content="true" name="octolytics-dimension-repository_public" /><meta content="true" name="octolytics-dimension-repository_is_fork" /><meta content="58729080" name="octolytics-dimension-repository_parent_id" /><meta content="darklord4822/KK_kernel_lenovo_a369i" name="octolytics-dimension-repository_parent_nwo" /><meta content="58729080" name="octolytics-dimension-repository_network_root_id" /><meta content="darklord4822/KK_kernel_lenovo_a369i" name="octolytics-dimension-repository_network_root_nwo" />

<meta content="/&lt;user-name&gt;/&lt;repo-name&gt;/blob/show" data-pjax-transient="true" name="analytics-location" />



  <meta class="js-ga-set" name="dimension1" content="Logged In">
    <meta class="js-ga-set" name="dimension3" content="mobile">




  <title>KK_kernel_lenovo_a369i/msg2133_driver.c at master Â· iuncuim/KK_kernel_lenovo_a369i</title>

  <link crossorigin="anonymous" href="https://assets-cdn.github.com/assets/mobile-d53178a6a7098f707ae5a45753b7def4340204f5d91cbd85263183dbc260da2f.css" media="all" rel="stylesheet" />


  <meta name="browser-stats-url" content="https://api.github.com/_private/browser/stats">

  <meta name="browser-errors-url" content="https://api.github.com/_private/browser/errors">

  <link rel="mask-icon" href="https://assets-cdn.github.com/pinned-octocat.svg" color="#000000">
  <link rel="icon" type="image/x-icon" href="https://assets-cdn.github.com/favicon.ico">

<meta name="theme-color" content="#1e2327">



  </head>

  <body>
    

  <header class="nav-bar">
    <div class="nav-bar-inner ">
      <button type="button" class="header-button header-nav-button touchable js-show-global-nav" data-ga-click="Mobile, tap, location:header; text:Hamburger">
        <svg aria-hidden="true" class="octicon octicon-three-bars" height="24" version="1.1" viewBox="0 0 12 16" width="18"><path fill-rule="evenodd" d="M11.41 9H.59C0 9 0 8.59 0 8c0-.59 0-1 .59-1H11.4c.59 0 .59.41.59 1 0 .59 0 1-.59 1h.01zm0-4H.59C0 5 0 4.59 0 4c0-.59 0-1 .59-1H11.4c.59 0 .59.41.59 1 0 .59 0 1-.59 1h.01zM.59 11H11.4c.59 0 .59.41.59 1 0 .59 0 1-.59 1H.59C0 13 0 12.59 0 12c0-.59 0-1 .59-1z"/></svg>
      </button>

      <div class="nav-bar-title-text">
            <svg aria-hidden="true" class="octicon octicon-repo-forked" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M8 1a1.993 1.993 0 0 0-1 3.72V6L5 8 3 6V4.72A1.993 1.993 0 0 0 2 1a1.993 1.993 0 0 0-1 3.72V6.5l3 3v1.78A1.993 1.993 0 0 0 5 15a1.993 1.993 0 0 0 1-3.72V9.5l3-3V4.72A1.993 1.993 0 0 0 8 1zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zm3 10c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zm3-10c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"/></svg>
  <strong><a class="text-white" href="/iuncuim">iuncuim</a></strong>
  /
  <strong><a class="text-white" href="/iuncuim/KK_kernel_lenovo_a369i">KK_kernel_lenovo_a369i</a></strong>

      </div>

      

    </div>


    <nav class="nav-bar-tabs ">
      <ul>
            <li>
              <a href="/" data-ga-click="Mobile, tap, location:header; text:Dashboard">
                <svg aria-hidden="true" class="octicon octicon-dashboard" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M9 5H8V4h1v1zm4 3h-1v1h1V8zM6 5H5v1h1V5zM5 8H4v1h1V8zm11-5.5l-.5-.5L9 7c-.06-.02-1 0-1 0-.55 0-1 .45-1 1v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-.92l6-5.58zm-1.59 4.09c.19.61.3 1.25.3 1.91 0 3.42-2.78 6.2-6.2 6.2-3.42 0-6.21-2.78-6.21-6.2 0-3.42 2.78-6.2 6.2-6.2 1.2 0 2.31.34 3.27.94l.94-.94A7.459 7.459 0 0 0 8.51 1C4.36 1 1 4.36 1 8.5 1 12.64 4.36 16 8.5 16c4.14 0 7.5-3.36 7.5-7.5 0-1.03-.2-2.02-.59-2.91l-1 1z"/></svg>
                Dashboard
              </a>
            </li>
          <li>
            <a href="/explore" data-ga-click="Mobile, tap, location:header; text:Explore">
              <svg aria-hidden="true" class="octicon octicon-telescope" height="16" version="1.1" viewBox="0 0 14 16" width="14"><path fill-rule="evenodd" d="M8 9l3 6h-1l-2-4v5H7v-6l-2 5H4l2-5 2-1zM7 0H6v1h1V0zM5 3H4v1h1V3zM2 1H1v1h1V1zM.63 9a.52.52 0 0 0-.16.67l.55.92c.13.23.41.31.64.2l1.39-.66-1.16-2-1.27.86.01.01zm7.89-5.39l-5.8 3.95L3.95 9.7l6.33-3.03-1.77-3.06h.01zm4.22 1.28l-1.47-2.52a.51.51 0 0 0-.72-.17l-1.2.83 1.84 3.2 1.33-.64c.27-.13.36-.44.22-.7z"/></svg>
              Explore
            </a>
          </li>
            <li>
              <a href="/Dialistar" data-ga-click="Mobile, tap, location:header; text:User avatar">
                <img alt="@Dialistar" class="avatar" height="16" src="https://avatars1.githubusercontent.com/u/25846784?v=3&amp;s=32" width="16" />
                Profile
              </a>
            </li>
        <li>
            <a href="/logout" data-ga-click="Mobile, tap, location:header; text:Sign out">
              <svg aria-hidden="true" class="octicon octicon-sign-out" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M12 9V7H8V5h4V3l4 3-4 3zm-2 3H6V3L2 1h8v3h1V1c0-.55-.45-1-1-1H1C.45 0 0 .45 0 1v11.38c0 .39.22.73.55.91L6 16.01V13h4c.55 0 1-.45 1-1V8h-1v4z"/></svg>
              Sign out
            </a>
        </li>
        
      </ul>
    </nav>
  </header>

    


  <div id="js-flash-container">
</div>


    




<div class="reponav-wrapper">
  <nav class="reponav js-reponav"
       itemscope
       itemtype="http://schema.org/BreadcrumbList">

    <span itemscope itemtype="http://schema.org/ListItem" itemprop="itemListElement">
      <a href="/iuncuim/KK_kernel_lenovo_a369i" class="js-selected-navigation-item selected reponav-item" data-selected-links="repo_source repo_downloads repo_commits repo_releases repo_tags repo_branches /iuncuim/KK_kernel_lenovo_a369i" itemprop="url">
        <span itemprop="name">Code</span>
        <meta itemprop="position" content="1">
</a>    </span>


    <span itemscope itemtype="http://schema.org/ListItem" itemprop="itemListElement">
      <a href="/iuncuim/KK_kernel_lenovo_a369i/pulls" class="js-selected-navigation-item reponav-item" data-selected-links="repo_pulls /iuncuim/KK_kernel_lenovo_a369i/pulls" itemprop="url">
        <span itemprop="name">Pull requests</span>
        <span class="counter">0</span>
        <meta itemprop="position" content="3">
</a>    </span>

    <a href="/iuncuim/KK_kernel_lenovo_a369i/pulse" class="js-selected-navigation-item reponav-item" data-selected-links="pulse /iuncuim/KK_kernel_lenovo_a369i/pulse">
      Pulse
</a>
  </nav>
</div>




<div class="breadcrumb blob-breadcrumb">
  <label for="blob-history-checkbox" class="blob-history-label">
    <svg aria-hidden="true" class="octicon octicon-history" height="16" version="1.1" viewBox="0 0 14 16" width="14"><path fill-rule="evenodd" d="M8 13H6V6h5v2H8v5zM7 1C4.81 1 2.87 2.02 1.59 3.59L0 2v4h4L2.5 4.5C3.55 3.17 5.17 2.3 7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-.34.03-.67.09-1H.08C.03 7.33 0 7.66 0 8c0 3.86 3.14 7 7 7s7-3.14 7-7-3.14-7-7-7z"/></svg>
  </label>
  <span class="filetype-icon"><svg aria-hidden="true" class="octicon octicon-file-text" height="16" version="1.1" viewBox="0 0 12 16" width="12"><path d="M6 5H2V4h4v1zM2 8h7V7H2v1zm0 2h7V9H2v1zm0 2h7v-1H2v1zm10-7.5V14c0 .55-.45 1-1 1H1c-.55 0-1-.45-1-1V2c0-.55.45-1 1-1h7.5L12 4.5zM11 5L8 2H1v12h10V5z"/></svg></span>
  <span class="js-path-segment"><a href="/iuncuim/KK_kernel_lenovo_a369i/tree/master/mediatek"><span>mediatek</span></a></span><span class="separator">/</span><span class="js-path-segment"><a href="/iuncuim/KK_kernel_lenovo_a369i/tree/master/mediatek/custom"><span>custom</span></a></span><span class="separator">/</span><span class="js-path-segment"><a href="/iuncuim/KK_kernel_lenovo_a369i/tree/master/mediatek/custom/common"><span>common</span></a></span><span class="separator">/</span><span class="js-path-segment"><a href="/iuncuim/KK_kernel_lenovo_a369i/tree/master/mediatek/custom/common/kernel"><span>kernel</span></a></span><span class="separator">/</span><span class="js-path-segment"><a href="/iuncuim/KK_kernel_lenovo_a369i/tree/master/mediatek/custom/common/kernel/touchpanel"><span>touchpanel</span></a></span><span class="separator">/</span><span class="js-path-segment"><a href="/iuncuim/KK_kernel_lenovo_a369i/tree/master/mediatek/custom/common/kernel/touchpanel/msg2133a"><span>msg2133a</span></a></span><span class="separator">/</span><strong class="final-path">msg2133_driver.c</strong>
</div>

<input id="blob-history-checkbox"
       class="js-blob-history-checkbox blob-history-checkbox"
       type="checkbox"
       data-url="/iuncuim/KK_kernel_lenovo_a369i/latest_commit/master/mediatek/custom/common/kernel/touchpanel/msg2133a/msg2133_driver.c">

<div class="blob-history">
  <a href="/iuncuim/KK_kernel_lenovo_a369i/commits/master/mediatek/custom/common/kernel/touchpanel/msg2133a/msg2133_driver.c" class="js-blob-history-link">
    Loading latest commitâ¦
</a></div>

  <div class="blob-file-content js-file-line-container">
    <div class="highlighted-blob tab-size" data-tab-size="8"><div class="code-body highlight"><pre><div class='line js-file-line' id='LC1'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&quot;</span>tpd.h<span class="pl-pds">&quot;</span></span></div><div class='line js-file-line' id='LC2'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/interrupt.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC3'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>cust_eint.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC4'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/i2c.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC5'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/sched.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC6'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/kthread.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC7'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/rtpm_prio.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC8'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/wait.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC9'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/time.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC10'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/delay.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC11'><br></div><div class='line js-file-line' id='LC12'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/dma-mapping.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC13'><br></div><div class='line js-file-line' id='LC14'><br></div><div class='line js-file-line' id='LC15'><span class="pl-c"><span class="pl-c">//</span>#define TPD_PROXIMITY</span></div><div class='line js-file-line' id='LC16'>#<span class="pl-k">ifdef</span> TPD_PROXIMITY</div><div class='line js-file-line' id='LC17'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/hwmsensor.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC18'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/hwmsen_dev.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC19'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/sensors_io.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC20'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC21'><br></div><div class='line js-file-line' id='LC22'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&quot;</span>tpd_custom_msg2133.h<span class="pl-pds">&quot;</span></span></div><div class='line js-file-line' id='LC23'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>mach/mt_pm_ldo.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC24'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>mach/mt_typedefs.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC25'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>mach/mt_boot.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC26'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>cust_eint.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC27'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&lt;</span>linux/jiffies.h<span class="pl-pds">&gt;</span></span></div><div class='line js-file-line' id='LC28'><br></div><div class='line js-file-line' id='LC29'>#<span class="pl-k">include</span> <span class="pl-s"><span class="pl-pds">&quot;</span>cust_gpio_usage.h<span class="pl-pds">&quot;</span></span></div><div class='line js-file-line' id='LC30'><br></div><div class='line js-file-line' id='LC31'>#<span class="pl-k">ifdef</span> TPD_HAVE_BUTTON </div><div class='line js-file-line' id='LC32'><span class="pl-k">static</span> <span class="pl-k">int</span> tpd_keys_local[TPD_KEY_COUNT] = TPD_KEYS;</div><div class='line js-file-line' id='LC33'><span class="pl-k">static</span> <span class="pl-k">int</span> tpd_keys_dim_local[TPD_KEY_COUNT][<span class="pl-c1">4</span>] = TPD_KEYS_DIM;</div><div class='line js-file-line' id='LC34'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC35'>#<span class="pl-k">if</span> (defined(TPD_WARP_START) &amp;&amp; defined(TPD_WARP_END))</div><div class='line js-file-line' id='LC36'><span class="pl-k">static</span> <span class="pl-k">int</span> tpd_wb_start_local[TPD_WARP_CNT] = TPD_WARP_START;</div><div class='line js-file-line' id='LC37'><span class="pl-k">static</span> <span class="pl-k">int</span> tpd_wb_end_local[TPD_WARP_CNT]   = TPD_WARP_END;</div><div class='line js-file-line' id='LC38'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC39'>#<span class="pl-k">if</span> (defined(TPD_HAVE_CALIBRATION) &amp;&amp; !defined(TPD_CUSTOM_CALIBRATION))</div><div class='line js-file-line' id='LC40'><span class="pl-k">static</span> <span class="pl-k">int</span> tpd_calmat_local[<span class="pl-c1">8</span>]     = TPD_CALIBRATION_MATRIX;</div><div class='line js-file-line' id='LC41'><span class="pl-k">static</span> <span class="pl-k">int</span> tpd_def_calmat_local[<span class="pl-c1">8</span>] = TPD_CALIBRATION_MATRIX;</div><div class='line js-file-line' id='LC42'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC43'><br></div><div class='line js-file-line' id='LC44'><span class="pl-k">extern</span> <span class="pl-k">struct</span> tpd_device *tpd;</div><div class='line js-file-line' id='LC45'><br></div><div class='line js-file-line' id='LC46'><span class="pl-k">static</span> <span class="pl-k">struct</span> i2c_client *i2c_client = <span class="pl-c1">NULL</span>;</div><div class='line js-file-line' id='LC47'><span class="pl-k">static</span> <span class="pl-k">struct</span> task_struct *thread = <span class="pl-c1">NULL</span>;</div><div class='line js-file-line' id='LC48'><br></div><div class='line js-file-line' id='LC49'><span class="pl-k">static</span> <span class="pl-en">DECLARE_WAIT_QUEUE_HEAD</span>(waiter);</div><div class='line js-file-line' id='LC50'><br></div><div class='line js-file-line' id='LC51'><br></div><div class='line js-file-line' id='LC52'><span class="pl-k">static</span> <span class="pl-k">void</span> <span class="pl-en">tpd_eint_interrupt_handler</span>(<span class="pl-k">void</span>);</div><div class='line js-file-line' id='LC53'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">tpd_probe</span>(<span class="pl-k">struct</span> i2c_client *client, <span class="pl-k">const</span> <span class="pl-k">struct</span> i2c_device_id *id);</div><div class='line js-file-line' id='LC54'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">tpd_detect</span>(<span class="pl-k">struct</span> i2c_client *client, <span class="pl-k">struct</span> i2c_board_info *info);</div><div class='line js-file-line' id='LC55'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">tpd_remove</span>(<span class="pl-k">struct</span> i2c_client *client);</div><div class='line js-file-line' id='LC56'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">touch_event_handler</span>(<span class="pl-k">void</span> *unused);</div><div class='line js-file-line' id='LC57'><br></div><div class='line js-file-line' id='LC58'><span class="pl-k">static</span> <span class="pl-k">int</span> tpd_flag = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC59'><span class="pl-k">static</span> <span class="pl-k">int</span> point_num = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC60'><span class="pl-k">static</span> <span class="pl-k">int</span> p_point_num = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC61'><br></div><div class='line js-file-line' id='LC62'><span class="pl-c"><span class="pl-c">//</span>#define TP_PROXIMITY_SENSOR</span></div><div class='line js-file-line' id='LC63'><br></div><div class='line js-file-line' id='LC64'><br></div><div class='line js-file-line' id='LC65'>#<span class="pl-k">define</span> <span class="pl-en">TPD_OK</span> <span class="pl-c1">0</span></div><div class='line js-file-line' id='LC66'><span class="pl-c"><span class="pl-c">//</span> debug macros</span></div><div class='line js-file-line' id='LC67'>#<span class="pl-k">if</span> defined(TP_DEBUG)</div><div class='line js-file-line' id='LC68'>#<span class="pl-k">define</span> <span class="pl-en">SSL_PRINT</span>(<span class="pl-v">x...</span>)		printk(<span class="pl-s"><span class="pl-pds">&quot;</span>MSG2133:<span class="pl-pds">&quot;</span></span>x)</div><div class='line js-file-line' id='LC69'>#<span class="pl-k">else</span></div><div class='line js-file-line' id='LC70'>#<span class="pl-k">define</span> <span class="pl-en">SSL_PRINT</span>(<span class="pl-v">format, args...</span>)  <span class="pl-k">do</span> {} <span class="pl-k">while</span> (<span class="pl-c1">0</span>)</div><div class='line js-file-line' id='LC71'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC72'><br></div><div class='line js-file-line' id='LC73'>#<span class="pl-k">ifdef</span> TP_PROXIMITY_SENSOR</div><div class='line js-file-line' id='LC74'><span class="pl-k">char</span> ps_data_state[<span class="pl-c1">1</span>] = {<span class="pl-c1">0</span>};</div><div class='line js-file-line' id='LC75'><span class="pl-k">enum</span></div><div class='line js-file-line' id='LC76'>{</div><div class='line js-file-line' id='LC77'>&nbsp;&nbsp;&nbsp;&nbsp;DISABLE_CTP_PS,</div><div class='line js-file-line' id='LC78'>&nbsp;&nbsp;&nbsp;&nbsp;ENABLE_CTP_PS,</div><div class='line js-file-line' id='LC79'>&nbsp;&nbsp;&nbsp;&nbsp;RESET_CTP_PS</div><div class='line js-file-line' id='LC80'>};</div><div class='line js-file-line' id='LC81'><span class="pl-k">char</span> tp_proximity_state = DISABLE_CTP_PS;  <span class="pl-c"><span class="pl-c">//</span>add by ningzhiyu</span></div><div class='line js-file-line' id='LC82'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC83'><span class="pl-c"><span class="pl-c">//</span>////////////////////////////////////////////////////////////////////////////add by lan</span></div><div class='line js-file-line' id='LC84'>#<span class="pl-k">ifdef</span> TPD_PROXIMITY</div><div class='line js-file-line' id='LC85'>#<span class="pl-k">define</span> <span class="pl-en">APS_ERR</span>(<span class="pl-v">fmt,arg...</span>)           	printk(<span class="pl-s"><span class="pl-pds">&quot;</span>&lt;&lt;proximity&gt;&gt; <span class="pl-pds">&quot;</span></span>fmt<span class="pl-s"><span class="pl-pds">&quot;</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>,##arg)</div><div class='line js-file-line' id='LC86'>#<span class="pl-k">define</span> <span class="pl-en">TPD_PROXIMITY_DEBUG</span>(<span class="pl-v">fmt,arg...</span>) printk(<span class="pl-s"><span class="pl-pds">&quot;</span>&lt;&lt;proximity&gt;&gt; <span class="pl-pds">&quot;</span></span>fmt<span class="pl-s"><span class="pl-pds">&quot;</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>,##arg)</div><div class='line js-file-line' id='LC87'>#<span class="pl-k">define</span> <span class="pl-en">TPD_PROXIMITY_DMESG</span>(<span class="pl-v">fmt,arg...</span>) printk(<span class="pl-s"><span class="pl-pds">&quot;</span>&lt;&lt;proximity&gt;&gt; <span class="pl-pds">&quot;</span></span>fmt<span class="pl-s"><span class="pl-pds">&quot;</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>,##arg)</div><div class='line js-file-line' id='LC88'><br></div><div class='line js-file-line' id='LC89'><span class="pl-k">static</span> u8 tpd_proximity_flag 			= <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC90'><span class="pl-k">static</span> u8 tpd_proximity_flag_one 		= <span class="pl-c1">0</span>; <span class="pl-c"><span class="pl-c">//</span>add for tpd_proximity by wangdongfang</span></div><div class='line js-file-line' id='LC91'><span class="pl-k">static</span> u8 tpd_proximity_detect 			= <span class="pl-c1">1</span>;<span class="pl-c"><span class="pl-c">//</span>0--&gt;close ; 1--&gt; far away</span></div><div class='line js-file-line' id='LC92'><br></div><div class='line js-file-line' id='LC93'><span class="pl-k">enum</span></div><div class='line js-file-line' id='LC94'>{</div><div class='line js-file-line' id='LC95'>&nbsp;&nbsp;&nbsp;&nbsp;DISABLE_CTP_PS,</div><div class='line js-file-line' id='LC96'>&nbsp;&nbsp;&nbsp;&nbsp;ENABLE_CTP_PS,</div><div class='line js-file-line' id='LC97'>&nbsp;&nbsp;&nbsp;&nbsp;RESET_CTP_PS</div><div class='line js-file-line' id='LC98'>};</div><div class='line js-file-line' id='LC99'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC100'><br></div><div class='line js-file-line' id='LC101'><br></div><div class='line js-file-line' id='LC102'><br></div><div class='line js-file-line' id='LC103'>#<span class="pl-k">define</span> <span class="pl-en">TOUCH_ADDR_MSG20XX</span>   0x4C</div><div class='line js-file-line' id='LC104'>#<span class="pl-k">define</span> <span class="pl-en">TOUCH_ADDR_MSG21XX</span>   0x26</div><div class='line js-file-line' id='LC105'><br></div><div class='line js-file-line' id='LC106'>#<span class="pl-k">define</span> <span class="pl-en">FW_ADDR_MSG20XX</span>      0xC4</div><div class='line js-file-line' id='LC107'>#<span class="pl-k">define</span> <span class="pl-en">FW_UPDATE_ADDR_MSG20XX</span>   0x92</div><div class='line js-file-line' id='LC108'><br></div><div class='line js-file-line' id='LC109'>#<span class="pl-k">define</span> <span class="pl-en">GPIO_CTP_MSG2133_EN_PIN</span>           GPIO_CTP_RST_PIN</div><div class='line js-file-line' id='LC110'>#<span class="pl-k">define</span> <span class="pl-en">GPIO_CTP_MSG2133_EN_PIN_M_GPIO</span>    GPIO_MODE_00</div><div class='line js-file-line' id='LC111'><br></div><div class='line js-file-line' id='LC112'>#<span class="pl-k">define</span> <span class="pl-en">GPIO_CTP_MSG2133_EINT_PIN</span>           GPIO_CTP_EINT_PIN</div><div class='line js-file-line' id='LC113'>#<span class="pl-k">define</span> <span class="pl-en">GPIO_CTP_MSG2133_EINT_PIN_M_GPIO</span>   GPIO_CTP_EINT_PIN_M_EINT</div><div class='line js-file-line' id='LC114'><br></div><div class='line js-file-line' id='LC115'>#<span class="pl-k">define</span> <span class="pl-en">TPD_POINT_INFO_LEN</span>      <span class="pl-c1">8</span></div><div class='line js-file-line' id='LC116'>#<span class="pl-k">define</span> <span class="pl-en">TPD_MAX_POINTS</span>          <span class="pl-c1">2</span></div><div class='line js-file-line' id='LC117'><br></div><div class='line js-file-line' id='LC118'><br></div><div class='line js-file-line' id='LC119'><span class="pl-k">struct</span> touch_info</div><div class='line js-file-line' id='LC120'>{</div><div class='line js-file-line' id='LC121'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">short</span> y[<span class="pl-c1">3</span>];</div><div class='line js-file-line' id='LC122'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">short</span> x[<span class="pl-c1">3</span>];</div><div class='line js-file-line' id='LC123'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">short</span> p[<span class="pl-c1">3</span>];</div><div class='line js-file-line' id='LC124'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">short</span> count;</div><div class='line js-file-line' id='LC125'>};</div><div class='line js-file-line' id='LC126'><br></div><div class='line js-file-line' id='LC127'><span class="pl-k">typedef</span> <span class="pl-k">struct</span></div><div class='line js-file-line' id='LC128'>{</div><div class='line js-file-line' id='LC129'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">short</span> pos_x;</div><div class='line js-file-line' id='LC130'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">short</span> pos_y;</div><div class='line js-file-line' id='LC131'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">short</span> pos_x2;</div><div class='line js-file-line' id='LC132'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">short</span> pos_y2;</div><div class='line js-file-line' id='LC133'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">short</span> temp2;</div><div class='line js-file-line' id='LC134'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">short</span> temp;</div><div class='line js-file-line' id='LC135'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">short</span> dst_x;</div><div class='line js-file-line' id='LC136'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">short</span> dst_y;</div><div class='line js-file-line' id='LC137'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">char</span> checksum;</div><div class='line js-file-line' id='LC138'><br></div><div class='line js-file-line' id='LC139'>} SHORT_TOUCH_STATE;</div><div class='line js-file-line' id='LC140'><br></div><div class='line js-file-line' id='LC141'><span class="pl-k">struct</span> msg_ts_priv </div><div class='line js-file-line' id='LC142'>{</div><div class='line js-file-line' id='LC143'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">int</span> buttons;</div><div class='line js-file-line' id='LC144'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">int</span>      prev_x[<span class="pl-c1">4</span>];</div><div class='line js-file-line' id='LC145'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">int</span>	prev_y[<span class="pl-c1">4</span>];</div><div class='line js-file-line' id='LC146'>};</div><div class='line js-file-line' id='LC147'><br></div><div class='line js-file-line' id='LC148'><span class="pl-k">struct</span> msg_ts_priv msg2133_priv;</div><div class='line js-file-line' id='LC149'><br></div><div class='line js-file-line' id='LC150'><br></div><div class='line js-file-line' id='LC151'><span class="pl-k">static</span> <span class="pl-k">const</span> <span class="pl-k">struct</span> i2c_device_id tpd_id[] = {{<span class="pl-s"><span class="pl-pds">&quot;</span>msg2133<span class="pl-pds">&quot;</span></span>, <span class="pl-c1">0</span>}, {}};</div><div class='line js-file-line' id='LC152'><span class="pl-k">static</span> <span class="pl-k">struct</span> i2c_board_info __initdata i2c_tpd={ <span class="pl-c1">I2C_BOARD_INFO</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>msg2133<span class="pl-pds">&quot;</span></span>, (TOUCH_ADDR_MSG20XX&gt;&gt;<span class="pl-c1">1</span>))};</div><div class='line js-file-line' id='LC153'><br></div><div class='line js-file-line' id='LC154'><span class="pl-k">static</span> <span class="pl-k">struct</span> i2c_driver tpd_i2c_driver =</div><div class='line js-file-line' id='LC155'>{</div><div class='line js-file-line' id='LC156'>.<span class="pl-smi">driver</span> = {</div><div class='line js-file-line' id='LC157'>	 .<span class="pl-smi">name</span> = <span class="pl-s"><span class="pl-pds">&quot;</span>msg2133<span class="pl-pds">&quot;</span></span>,</div><div class='line js-file-line' id='LC158'><span class="pl-c"><span class="pl-c">//</span>	 .owner = THIS_MODULE,</span></div><div class='line js-file-line' id='LC159'>&nbsp;&nbsp;},</div><div class='line js-file-line' id='LC160'>&nbsp;&nbsp;&nbsp;&nbsp;.<span class="pl-smi">probe</span> = tpd_probe,</div><div class='line js-file-line' id='LC161'>&nbsp;&nbsp;&nbsp;&nbsp;.<span class="pl-smi">remove</span> = tpd_remove,</div><div class='line js-file-line' id='LC162'>&nbsp;&nbsp;&nbsp;&nbsp;.<span class="pl-smi">detect</span> = tpd_detect,</div><div class='line js-file-line' id='LC163'>&nbsp;&nbsp;&nbsp;&nbsp;.<span class="pl-smi">driver</span>.<span class="pl-smi">name</span> = <span class="pl-s"><span class="pl-pds">&quot;</span>msg2133<span class="pl-pds">&quot;</span></span>,</div><div class='line js-file-line' id='LC164'>&nbsp;&nbsp;&nbsp;&nbsp;.<span class="pl-smi">id_table</span> = tpd_id,</div><div class='line js-file-line' id='LC165'><br></div><div class='line js-file-line' id='LC166'>};</div><div class='line js-file-line' id='LC167'><br></div><div class='line js-file-line' id='LC168'><br></div><div class='line js-file-line' id='LC169'><span class="pl-k">static</span> <span class="pl-k">void</span> <span class="pl-en">MSG2133_En_Pin_Out</span>(u8 flag)</div><div class='line js-file-line' id='LC170'>{</div><div class='line js-file-line' id='LC171'>	<span class="pl-k">if</span>(flag==<span class="pl-c1">1</span>)</div><div class='line js-file-line' id='LC172'>	{</div><div class='line js-file-line' id='LC173'>#<span class="pl-k">ifdef</span> EN_PIN_1_8_V</div><div class='line js-file-line' id='LC174'>		<span class="pl-c1">mt_set_gpio_mode</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_CTP_MSG2133_EN_PIN_M_GPIO);</div><div class='line js-file-line' id='LC175'>		<span class="pl-c1">mt_set_gpio_dir</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_DIR_IN);</div><div class='line js-file-line' id='LC176'>		<span class="pl-c1">mt_set_gpio_pull_enable</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_PULL_DISABLE);</div><div class='line js-file-line' id='LC177'>		<span class="pl-c1">msleep</span>(<span class="pl-c1">10</span>);</div><div class='line js-file-line' id='LC178'>		<span class="pl-k">if</span>(<span class="pl-c1">mt_get_gpio_in</span>(GPIO_CTP_MSG2133_EN_PIN)==<span class="pl-c1">0</span>)</div><div class='line js-file-line' id='LC179'>		{</div><div class='line js-file-line' id='LC180'>			<span class="pl-c1">mt_set_gpio_dir</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_DIR_OUT);</div><div class='line js-file-line' id='LC181'>			<span class="pl-c1">mt_set_gpio_out</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_OUT_ONE);</div><div class='line js-file-line' id='LC182'>			<span class="pl-c1">mt_set_gpio_pull_enable</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_PULL_ENABLE);</div><div class='line js-file-line' id='LC183'>			<span class="pl-c1">mt_set_gpio_pull_select</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_PULL_UP);</div><div class='line js-file-line' id='LC184'>		}</div><div class='line js-file-line' id='LC185'>#<span class="pl-k">else</span></div><div class='line js-file-line' id='LC186'>		<span class="pl-c1">mt_set_gpio_mode</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_CTP_MSG2133_EN_PIN_M_GPIO);</div><div class='line js-file-line' id='LC187'>		<span class="pl-c1">mt_set_gpio_dir</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_DIR_OUT);</div><div class='line js-file-line' id='LC188'>		<span class="pl-c1">mt_set_gpio_out</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_OUT_ONE);</div><div class='line js-file-line' id='LC189'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC190'>	}</div><div class='line js-file-line' id='LC191'>	<span class="pl-k">else</span></div><div class='line js-file-line' id='LC192'>	{</div><div class='line js-file-line' id='LC193'>		<span class="pl-c1">mt_set_gpio_mode</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_CTP_MSG2133_EN_PIN_M_GPIO);</div><div class='line js-file-line' id='LC194'>		<span class="pl-c1">mt_set_gpio_dir</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_DIR_OUT);</div><div class='line js-file-line' id='LC195'>#<span class="pl-k">ifdef</span> EN_PIN_1_8_V</div><div class='line js-file-line' id='LC196'>		<span class="pl-c1">mt_set_gpio_pull_enable</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_PULL_ENABLE);</div><div class='line js-file-line' id='LC197'>		<span class="pl-c1">mt_set_gpio_pull_select</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_PULL_DOWN);</div><div class='line js-file-line' id='LC198'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC199'>		<span class="pl-c1">mt_set_gpio_out</span>(GPIO_CTP_MSG2133_EN_PIN, GPIO_OUT_ZERO);</div><div class='line js-file-line' id='LC200'>	}</div><div class='line js-file-line' id='LC201'>}</div><div class='line js-file-line' id='LC202'><br></div><div class='line js-file-line' id='LC203'><br></div><div class='line js-file-line' id='LC204'>#<span class="pl-k">ifdef</span> TP_FIRMWARE_UPDATE</div><div class='line js-file-line' id='LC205'><span class="pl-c"><span class="pl-c">/*</span>FW UPDATE<span class="pl-c">*/</span></span></div><div class='line js-file-line' id='LC206'>#<span class="pl-k">define</span> <span class="pl-en">DBG</span> 		<span class="pl-c"><span class="pl-c">//</span>printk</span></div><div class='line js-file-line' id='LC207'>#<span class="pl-k">define</span> <span class="pl-en">FW_ADDR_MSG2133</span>   0x62<span class="pl-c"><span class="pl-c">//</span>device address of msg2133</span></div><div class='line js-file-line' id='LC208'>#<span class="pl-k">define</span> <span class="pl-en">FW_UPDATE_ADDR_MSG2133</span>   0x49</div><div class='line js-file-line' id='LC209'>#<span class="pl-k">define</span>   <span class="pl-en">DOWNLOAD_FIRMWARE_BUF_SIZE</span>   <span class="pl-c1">59</span>*<span class="pl-c1">1024</span></div><div class='line js-file-line' id='LC210'><span class="pl-k">static</span> U8 *download_firmware_buf = <span class="pl-c1">NULL</span>;</div><div class='line js-file-line' id='LC211'><span class="pl-k">static</span> <span class="pl-k">int</span> FwDataCnt;</div><div class='line js-file-line' id='LC212'><span class="pl-k">struct</span> class *firmware_class;</div><div class='line js-file-line' id='LC213'><span class="pl-k">struct</span> device *firmware_cmd_dev;</div><div class='line js-file-line' id='LC214'><span class="pl-k">static</span>  <span class="pl-k">char</span> *fw_version;</div><div class='line js-file-line' id='LC215'><span class="pl-c"><span class="pl-c">//</span>static int update_switch = 0;</span></div><div class='line js-file-line' id='LC216'><br></div><div class='line js-file-line' id='LC217'>#<span class="pl-k">define</span> <span class="pl-en">MAX_CMD_LEN</span> <span class="pl-c1">255</span></div><div class='line js-file-line' id='LC218'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">i2c_master_send</span>(<span class="pl-k">struct</span> i2c_client *client, <span class="pl-k">char</span> *buf ,<span class="pl-k">int</span> count)</div><div class='line js-file-line' id='LC219'>{</div><div class='line js-file-line' id='LC220'>	u8 *buf_dma = <span class="pl-c1">NULL</span>;</div><div class='line js-file-line' id='LC221'>	u32 old_addr = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC222'>	<span class="pl-k">int</span> ret = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC223'>	<span class="pl-k">int</span> retry = <span class="pl-c1">3</span>;</div><div class='line js-file-line' id='LC224'><br></div><div class='line js-file-line' id='LC225'>	<span class="pl-k">if</span> (count &gt; MAX_CMD_LEN) {</div><div class='line js-file-line' id='LC226'>		<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>[i2c_master_send_ext] exceed the max write length <span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC227'>		<span class="pl-k">return</span> -<span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC228'>	}</div><div class='line js-file-line' id='LC229'><br></div><div class='line js-file-line' id='LC230'>	buf_dma= <span class="pl-c1">kmalloc</span>(count,GFP_KERNEL);</div><div class='line js-file-line' id='LC231'><br></div><div class='line js-file-line' id='LC232'>	old_addr = client-&gt;addr;</div><div class='line js-file-line' id='LC233'>	client-&gt;addr |= I2C_ENEXT_FLAG ;</div><div class='line js-file-line' id='LC234'><br></div><div class='line js-file-line' id='LC235'>	<span class="pl-c1">memcpy</span>(buf_dma, buf, count);</div><div class='line js-file-line' id='LC236'><br></div><div class='line js-file-line' id='LC237'>	<span class="pl-k">do</span> {</div><div class='line js-file-line' id='LC238'>		ret = <span class="pl-c1">i2c_master_send</span>(client, (u8*)buf_dma, count);</div><div class='line js-file-line' id='LC239'>		retry --;</div><div class='line js-file-line' id='LC240'>		<span class="pl-k">if</span> (ret != count) {</div><div class='line js-file-line' id='LC241'>			<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>[i2c_master_send_ext] Error sent I2C ret = <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, ret);</div><div class='line js-file-line' id='LC242'>		}</div><div class='line js-file-line' id='LC243'>	}<span class="pl-k">while</span> ((ret != count) &amp;&amp; (retry &gt; <span class="pl-c1">0</span>));</div><div class='line js-file-line' id='LC244'><br></div><div class='line js-file-line' id='LC245'>	client-&gt;addr = old_addr;</div><div class='line js-file-line' id='LC246'>	<span class="pl-c1">kfree</span>(buf_dma);</div><div class='line js-file-line' id='LC247'><br></div><div class='line js-file-line' id='LC248'>	<span class="pl-k">return</span> ret;</div><div class='line js-file-line' id='LC249'><br></div><div class='line js-file-line' id='LC250'>}</div><div class='line js-file-line' id='LC251'><br></div><div class='line js-file-line' id='LC252'><br></div><div class='line js-file-line' id='LC253'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">i2c_master_recv_ext</span>(<span class="pl-k">struct</span> i2c_client *client, <span class="pl-k">char</span> *buf ,<span class="pl-k">int</span> count)</div><div class='line js-file-line' id='LC254'>{</div><div class='line js-file-line' id='LC255'>	u32 phyAddr = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC256'>	u8  buf_dma[<span class="pl-c1">8</span>] = {<span class="pl-c1">0</span>};</div><div class='line js-file-line' id='LC257'>	u32 old_addr = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC258'>	<span class="pl-k">int</span> ret = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC259'>	<span class="pl-k">int</span> retry = <span class="pl-c1">3</span>;</div><div class='line js-file-line' id='LC260'>	<span class="pl-k">int</span> i = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC261'>	u8  *buf_test ;</div><div class='line js-file-line' id='LC262'>	buf_test = &amp;buf_dma[<span class="pl-c1">0</span>];</div><div class='line js-file-line' id='LC263'><br></div><div class='line js-file-line' id='LC264'>	old_addr = client-&gt;addr;</div><div class='line js-file-line' id='LC265'>	client-&gt;addr |= I2C_ENEXT_FLAG ;</div><div class='line js-file-line' id='LC266'><br></div><div class='line js-file-line' id='LC267'>	<span class="pl-c1">DBG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>[i2c_master_recv_ext] client-&gt;addr = <span class="pl-c1">%x</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, client-&gt;addr);</div><div class='line js-file-line' id='LC268'><br></div><div class='line js-file-line' id='LC269'>	<span class="pl-k">do</span> {</div><div class='line js-file-line' id='LC270'>		ret = <span class="pl-c1">i2c_master_recv</span>(client, buf_dma, count);</div><div class='line js-file-line' id='LC271'>		retry --;</div><div class='line js-file-line' id='LC272'>		<span class="pl-k">if</span> (ret != count) {</div><div class='line js-file-line' id='LC273'>			<span class="pl-c1">DBG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>[i2c_master_recv_ext] Error sent I2C ret = <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, ret);</div><div class='line js-file-line' id='LC274'>		}</div><div class='line js-file-line' id='LC275'>	}<span class="pl-k">while</span> ((ret != count) &amp;&amp; (retry &gt; <span class="pl-c1">0</span>));</div><div class='line js-file-line' id='LC276'><br></div><div class='line js-file-line' id='LC277'>	<span class="pl-c1">memcpy</span>(buf, buf_dma, count);</div><div class='line js-file-line' id='LC278'><br></div><div class='line js-file-line' id='LC279'>	client-&gt;addr = old_addr;</div><div class='line js-file-line' id='LC280'><br></div><div class='line js-file-line' id='LC281'>	<span class="pl-k">return</span> ret;</div><div class='line js-file-line' id='LC282'>}</div><div class='line js-file-line' id='LC283'><span class="pl-k">void</span> <span class="pl-en">HalTscrCDevWriteI2CSeq</span>(u8 addr, u8* data, u16 size)</div><div class='line js-file-line' id='LC284'>{</div><div class='line js-file-line' id='LC285'>	u8 addr_bak;</div><div class='line js-file-line' id='LC286'><br></div><div class='line js-file-line' id='LC287'>	addr_bak = i2c_client-&gt;addr;</div><div class='line js-file-line' id='LC288'>	i2c_client-&gt;addr = addr;</div><div class='line js-file-line' id='LC289'>	i2c_client-&gt;addr |= I2C_ENEXT_FLAG;</div><div class='line js-file-line' id='LC290'>	<span class="pl-c1">i2c_master_send</span>(i2c_client,data,size);</div><div class='line js-file-line' id='LC291'>	i2c_client-&gt;addr = addr_bak;</div><div class='line js-file-line' id='LC292'>}</div><div class='line js-file-line' id='LC293'><br></div><div class='line js-file-line' id='LC294'><br></div><div class='line js-file-line' id='LC295'><span class="pl-k">void</span> <span class="pl-en">HalTscrCReadI2CSeq</span>(u8 addr, u8* read_data, u8 size)</div><div class='line js-file-line' id='LC296'>{</div><div class='line js-file-line' id='LC297'>	u8 addr_bak;</div><div class='line js-file-line' id='LC298'><br></div><div class='line js-file-line' id='LC299'>	addr_bak = i2c_client-&gt;addr;</div><div class='line js-file-line' id='LC300'>	i2c_client-&gt;addr = addr;</div><div class='line js-file-line' id='LC301'>	i2c_client-&gt;addr |= I2C_ENEXT_FLAG;</div><div class='line js-file-line' id='LC302'>	<span class="pl-c1">i2c_master_recv_ext</span>(i2c_client,read_data,size);</div><div class='line js-file-line' id='LC303'>	i2c_client-&gt;addr = addr_bak;</div><div class='line js-file-line' id='LC304'>}</div><div class='line js-file-line' id='LC305'><br></div><div class='line js-file-line' id='LC306'><br></div><div class='line js-file-line' id='LC307'><span class="pl-k">void</span> <span class="pl-en">Get_Chip_Version</span>(<span class="pl-k">void</span>)</div><div class='line js-file-line' id='LC308'>{</div><div class='line js-file-line' id='LC309'><br></div><div class='line js-file-line' id='LC310'>	<span class="pl-k">unsigned</span> <span class="pl-k">char</span> dbbus_tx_data[<span class="pl-c1">3</span>];</div><div class='line js-file-line' id='LC311'>	<span class="pl-k">unsigned</span> <span class="pl-k">char</span> dbbus_rx_data[<span class="pl-c1">2</span>];</div><div class='line js-file-line' id='LC312'><br></div><div class='line js-file-line' id='LC313'>	dbbus_tx_data[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC314'>	dbbus_tx_data[<span class="pl-c1">1</span>] = 0x1E;</div><div class='line js-file-line' id='LC315'>	dbbus_tx_data[<span class="pl-c1">2</span>] = 0xCE;</div><div class='line js-file-line' id='LC316'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, &amp;dbbus_tx_data[<span class="pl-c1">0</span>], <span class="pl-c1">3</span>);</div><div class='line js-file-line' id='LC317'>	<span class="pl-c1">HalTscrCReadI2CSeq</span>(FW_ADDR_MSG2133, &amp;dbbus_rx_data[<span class="pl-c1">0</span>], <span class="pl-c1">2</span>);</div><div class='line js-file-line' id='LC318'>	<span class="pl-k">if</span> (dbbus_rx_data[<span class="pl-c1">1</span>] == <span class="pl-c1">0</span>)</div><div class='line js-file-line' id='LC319'>	{</div><div class='line js-file-line' id='LC320'>		<span class="pl-c"><span class="pl-c">//</span> it is Catch2</span></div><div class='line js-file-line' id='LC321'>		<span class="pl-c1">DBG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>*** Catch2 ***<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC322'>		<span class="pl-c"><span class="pl-c">//</span>FwVersion  = 2;// 2 means Catch2</span></div><div class='line js-file-line' id='LC323'>	}</div><div class='line js-file-line' id='LC324'>	<span class="pl-k">else</span></div><div class='line js-file-line' id='LC325'>	{</div><div class='line js-file-line' id='LC326'>		<span class="pl-c"><span class="pl-c">//</span> it is catch1</span></div><div class='line js-file-line' id='LC327'>		<span class="pl-c1">DBG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>*** Catch1 ***<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC328'>		<span class="pl-c"><span class="pl-c">//</span>FwVersion  = 1;// 1 means Catch1</span></div><div class='line js-file-line' id='LC329'>	}</div><div class='line js-file-line' id='LC330'><br></div><div class='line js-file-line' id='LC331'>}</div><div class='line js-file-line' id='LC332'><br></div><div class='line js-file-line' id='LC333'><span class="pl-k">void</span> <span class="pl-en">dbbusDWIICEnterSerialDebugMode</span>()</div><div class='line js-file-line' id='LC334'>{</div><div class='line js-file-line' id='LC335'>	U8 data[<span class="pl-c1">5</span>];</div><div class='line js-file-line' id='LC336'><br></div><div class='line js-file-line' id='LC337'>	<span class="pl-c"><span class="pl-c">//</span> Enter the Serial Debug Mode</span></div><div class='line js-file-line' id='LC338'>	data[<span class="pl-c1">0</span>] = 0x53;</div><div class='line js-file-line' id='LC339'>	data[<span class="pl-c1">1</span>] = 0x45;</div><div class='line js-file-line' id='LC340'>	data[<span class="pl-c1">2</span>] = 0x52;</div><div class='line js-file-line' id='LC341'>	data[<span class="pl-c1">3</span>] = 0x44;</div><div class='line js-file-line' id='LC342'>	data[<span class="pl-c1">4</span>] = 0x42;</div><div class='line js-file-line' id='LC343'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, data, <span class="pl-c1">5</span>);</div><div class='line js-file-line' id='LC344'>}</div><div class='line js-file-line' id='LC345'><br></div><div class='line js-file-line' id='LC346'><span class="pl-k">void</span> <span class="pl-en">dbbusDWIICStopMCU</span>()</div><div class='line js-file-line' id='LC347'>{</div><div class='line js-file-line' id='LC348'>	U8 data[<span class="pl-c1">1</span>];</div><div class='line js-file-line' id='LC349'><br></div><div class='line js-file-line' id='LC350'>	<span class="pl-c"><span class="pl-c">//</span> Stop the MCU</span></div><div class='line js-file-line' id='LC351'>	data[<span class="pl-c1">0</span>] = 0x37;</div><div class='line js-file-line' id='LC352'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, data, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC353'>}</div><div class='line js-file-line' id='LC354'><br></div><div class='line js-file-line' id='LC355'><span class="pl-k">void</span> <span class="pl-en">dbbusDWIICIICUseBus</span>()</div><div class='line js-file-line' id='LC356'>{</div><div class='line js-file-line' id='LC357'>	U8 data[<span class="pl-c1">1</span>];</div><div class='line js-file-line' id='LC358'><br></div><div class='line js-file-line' id='LC359'>	<span class="pl-c"><span class="pl-c">//</span> IIC Use Bus</span></div><div class='line js-file-line' id='LC360'>	data[<span class="pl-c1">0</span>] = 0x35;</div><div class='line js-file-line' id='LC361'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, data, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC362'>}</div><div class='line js-file-line' id='LC363'><br></div><div class='line js-file-line' id='LC364'><span class="pl-k">void</span> <span class="pl-en">dbbusDWIICIICReshape</span>()</div><div class='line js-file-line' id='LC365'>{</div><div class='line js-file-line' id='LC366'>	U8 data[<span class="pl-c1">1</span>];</div><div class='line js-file-line' id='LC367'><br></div><div class='line js-file-line' id='LC368'>	<span class="pl-c"><span class="pl-c">//</span> IIC Re-shape</span></div><div class='line js-file-line' id='LC369'>	data[<span class="pl-c1">0</span>] = 0x71;</div><div class='line js-file-line' id='LC370'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, data, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC371'>}</div><div class='line js-file-line' id='LC372'><br></div><div class='line js-file-line' id='LC373'><span class="pl-k">void</span> <span class="pl-en">dbbusDWIICIICNotUseBus</span>()</div><div class='line js-file-line' id='LC374'>{</div><div class='line js-file-line' id='LC375'>	U8 data[<span class="pl-c1">1</span>];</div><div class='line js-file-line' id='LC376'><br></div><div class='line js-file-line' id='LC377'>	<span class="pl-c"><span class="pl-c">//</span> IIC Not Use Bus</span></div><div class='line js-file-line' id='LC378'>	data[<span class="pl-c1">0</span>] = 0x34;</div><div class='line js-file-line' id='LC379'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, data, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC380'>}</div><div class='line js-file-line' id='LC381'><br></div><div class='line js-file-line' id='LC382'><span class="pl-k">void</span> <span class="pl-en">dbbusDWIICNotStopMCU</span>()</div><div class='line js-file-line' id='LC383'>{</div><div class='line js-file-line' id='LC384'>	U8 data[<span class="pl-c1">1</span>];</div><div class='line js-file-line' id='LC385'><br></div><div class='line js-file-line' id='LC386'>	<span class="pl-c"><span class="pl-c">//</span> Not Stop the MCU</span></div><div class='line js-file-line' id='LC387'>	data[<span class="pl-c1">0</span>] = 0x36;</div><div class='line js-file-line' id='LC388'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, data, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC389'>}</div><div class='line js-file-line' id='LC390'><br></div><div class='line js-file-line' id='LC391'><span class="pl-k">void</span> <span class="pl-en">dbbusDWIICExitSerialDebugMode</span>()</div><div class='line js-file-line' id='LC392'>{</div><div class='line js-file-line' id='LC393'>	U8 data[<span class="pl-c1">1</span>];</div><div class='line js-file-line' id='LC394'><br></div><div class='line js-file-line' id='LC395'>	<span class="pl-c"><span class="pl-c">//</span> Exit the Serial Debug Mode</span></div><div class='line js-file-line' id='LC396'>	data[<span class="pl-c1">0</span>] = 0x45;</div><div class='line js-file-line' id='LC397'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, data, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC398'><br></div><div class='line js-file-line' id='LC399'>	<span class="pl-c"><span class="pl-c">//</span> Delay some interval to guard the next transaction</span></div><div class='line js-file-line' id='LC400'>	<span class="pl-c"><span class="pl-c">//</span>udelay ( 200 );        // delay about 0.2ms</span></div><div class='line js-file-line' id='LC401'>}</div><div class='line js-file-line' id='LC402'><br></div><div class='line js-file-line' id='LC403'><span class="pl-k">void</span> <span class="pl-en">drvISP_EntryIspMode</span>(<span class="pl-k">void</span>)</div><div class='line js-file-line' id='LC404'>{</div><div class='line js-file-line' id='LC405'>	U8 bWriteData[<span class="pl-c1">5</span>] =</div><div class='line js-file-line' id='LC406'>	{</div><div class='line js-file-line' id='LC407'>		0x4D, 0x53, 0x54, 0x41, 0x52</div><div class='line js-file-line' id='LC408'>	};</div><div class='line js-file-line' id='LC409'><br></div><div class='line js-file-line' id='LC410'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, bWriteData, <span class="pl-c1">5</span>);</div><div class='line js-file-line' id='LC411'><br></div><div class='line js-file-line' id='LC412'>	<span class="pl-c"><span class="pl-c">//</span>udelay ( 1000 );        // delay about 1ms</span></div><div class='line js-file-line' id='LC413'>}</div><div class='line js-file-line' id='LC414'><br></div><div class='line js-file-line' id='LC415'>U8 <span class="pl-en">drvISP_Read</span>(U8 n, U8* pDataToRead)    <span class="pl-c"><span class="pl-c">//</span>First it needs send 0x11 to notify we want to get flash data back.</span></div><div class='line js-file-line' id='LC416'>{</div><div class='line js-file-line' id='LC417'>	U8 Read_cmd = 0x11;</div><div class='line js-file-line' id='LC418'>	<span class="pl-k">unsigned</span> <span class="pl-k">char</span> dbbus_rx_data[<span class="pl-c1">2</span>] = {<span class="pl-c1">0</span>};</div><div class='line js-file-line' id='LC419'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, &amp;Read_cmd, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC420'>	<span class="pl-c1">udelay</span>(<span class="pl-c1">100</span>);<span class="pl-c"><span class="pl-c">//</span>10 zzf</span></div><div class='line js-file-line' id='LC421'>	<span class="pl-k">if</span> (n == <span class="pl-c1">1</span>)</div><div class='line js-file-line' id='LC422'>	{</div><div class='line js-file-line' id='LC423'>		<span class="pl-c1">HalTscrCReadI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, &amp;dbbus_rx_data[<span class="pl-c1">0</span>], <span class="pl-c1">2</span>);</div><div class='line js-file-line' id='LC424'>		*pDataToRead = dbbus_rx_data[<span class="pl-c1">0</span>];</div><div class='line js-file-line' id='LC425'>	}</div><div class='line js-file-line' id='LC426'>	<span class="pl-k">else</span></div><div class='line js-file-line' id='LC427'>		<span class="pl-c1">HalTscrCReadI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, pDataToRead, n);</div><div class='line js-file-line' id='LC428'><br></div><div class='line js-file-line' id='LC429'>}</div><div class='line js-file-line' id='LC430'><br></div><div class='line js-file-line' id='LC431'><span class="pl-k">void</span> <span class="pl-en">drvISP_WriteEnable</span>(<span class="pl-k">void</span>)</div><div class='line js-file-line' id='LC432'>{</div><div class='line js-file-line' id='LC433'>	U8 bWriteData[<span class="pl-c1">2</span>] =</div><div class='line js-file-line' id='LC434'>	{</div><div class='line js-file-line' id='LC435'>		0x10, 0x06</div><div class='line js-file-line' id='LC436'>	};</div><div class='line js-file-line' id='LC437'>	U8 bWriteData1 = 0x12;</div><div class='line js-file-line' id='LC438'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, bWriteData, <span class="pl-c1">2</span>);</div><div class='line js-file-line' id='LC439'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, &amp;bWriteData1, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC440'>}</div><div class='line js-file-line' id='LC441'><br></div><div class='line js-file-line' id='LC442'><br></div><div class='line js-file-line' id='LC443'><span class="pl-k">void</span> <span class="pl-en">drvISP_ExitIspMode</span>(<span class="pl-k">void</span>)</div><div class='line js-file-line' id='LC444'>{</div><div class='line js-file-line' id='LC445'>	U8 bWriteData = 0x24;</div><div class='line js-file-line' id='LC446'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, &amp;bWriteData, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC447'>}</div><div class='line js-file-line' id='LC448'><br></div><div class='line js-file-line' id='LC449'>U8 <span class="pl-en">drvISP_ReadStatus</span>()</div><div class='line js-file-line' id='LC450'>{</div><div class='line js-file-line' id='LC451'>	U8 bReadData = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC452'>	U8 bWriteData[<span class="pl-c1">2</span>] =</div><div class='line js-file-line' id='LC453'>	{</div><div class='line js-file-line' id='LC454'>		0x10, 0x05</div><div class='line js-file-line' id='LC455'>	};</div><div class='line js-file-line' id='LC456'>	U8 bWriteData1 = 0x12;</div><div class='line js-file-line' id='LC457'><br></div><div class='line js-file-line' id='LC458'>	<span class="pl-c1">udelay</span>(<span class="pl-c1">100</span>);</div><div class='line js-file-line' id='LC459'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, bWriteData, <span class="pl-c1">2</span>);</div><div class='line js-file-line' id='LC460'>	<span class="pl-c1">udelay</span>(<span class="pl-c1">100</span>);</div><div class='line js-file-line' id='LC461'>	<span class="pl-c1">drvISP_Read</span>(<span class="pl-c1">1</span>, &amp;bReadData);</div><div class='line js-file-line' id='LC462'>	<span class="pl-c1">mdelay</span>(<span class="pl-c1">10</span>);<span class="pl-c"><span class="pl-c">//</span>3-&gt;10 zzf</span></div><div class='line js-file-line' id='LC463'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, &amp;bWriteData1, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC464'>	<span class="pl-k">return</span> bReadData;</div><div class='line js-file-line' id='LC465'>}</div><div class='line js-file-line' id='LC466'><br></div><div class='line js-file-line' id='LC467'><br></div><div class='line js-file-line' id='LC468'><span class="pl-k">void</span> <span class="pl-en">drvISP_BlockErase</span>(U32 addr)</div><div class='line js-file-line' id='LC469'>{</div><div class='line js-file-line' id='LC470'>	U8 bWriteData[<span class="pl-c1">5</span>] = { 0x00, 0x00, 0x00, 0x00, 0x00 };</div><div class='line js-file-line' id='LC471'>	U8 bWriteData1 = 0x12;</div><div class='line js-file-line' id='LC472'>	u32 timeOutCount=<span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC473'>	<span class="pl-c1">drvISP_WriteEnable</span>();</div><div class='line js-file-line' id='LC474'><br></div><div class='line js-file-line' id='LC475'>	<span class="pl-c"><span class="pl-c">//</span>Enable write status register</span></div><div class='line js-file-line' id='LC476'>	bWriteData[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC477'>	bWriteData[<span class="pl-c1">1</span>] = 0x50;</div><div class='line js-file-line' id='LC478'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, bWriteData, <span class="pl-c1">2</span>);</div><div class='line js-file-line' id='LC479'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, &amp;bWriteData1, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC480'><br></div><div class='line js-file-line' id='LC481'>	<span class="pl-c"><span class="pl-c">//</span>Write Status</span></div><div class='line js-file-line' id='LC482'>	bWriteData[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC483'>	bWriteData[<span class="pl-c1">1</span>] = 0x01;</div><div class='line js-file-line' id='LC484'>	bWriteData[<span class="pl-c1">2</span>] = 0x00;</div><div class='line js-file-line' id='LC485'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, bWriteData, <span class="pl-c1">3</span>);</div><div class='line js-file-line' id='LC486'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, &amp;bWriteData1, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC487'><br></div><div class='line js-file-line' id='LC488'>	<span class="pl-c"><span class="pl-c">//</span>Write disable</span></div><div class='line js-file-line' id='LC489'>	bWriteData[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC490'>	bWriteData[<span class="pl-c1">1</span>] = 0x04;</div><div class='line js-file-line' id='LC491'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, bWriteData, <span class="pl-c1">2</span>);</div><div class='line js-file-line' id='LC492'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, &amp;bWriteData1, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC493'><br></div><div class='line js-file-line' id='LC494'>	<span class="pl-c1">udelay</span>(<span class="pl-c1">100</span>);</div><div class='line js-file-line' id='LC495'>	timeOutCount=<span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC496'>	<span class="pl-k">while</span> ( ( <span class="pl-c1">drvISP_ReadStatus</span>() &amp; 0x01 ) == 0x01 )</div><div class='line js-file-line' id='LC497'>	{</div><div class='line js-file-line' id='LC498'>		timeOutCount++;</div><div class='line js-file-line' id='LC499'>		<span class="pl-k">if</span> ( timeOutCount &gt;= <span class="pl-c1">10000</span> )</div><div class='line js-file-line' id='LC500'>			<span class="pl-k">break</span>; <span class="pl-c"><span class="pl-c">/*</span> around 1 sec timeout <span class="pl-c">*/</span></span></div><div class='line js-file-line' id='LC501'>	}</div><div class='line js-file-line' id='LC502'>	<span class="pl-c1">drvISP_WriteEnable</span>();</div><div class='line js-file-line' id='LC503'><br></div><div class='line js-file-line' id='LC504'>	<span class="pl-c1">drvISP_ReadStatus</span>();<span class="pl-c"><span class="pl-c">//</span>zzf</span></div><div class='line js-file-line' id='LC505'><br></div><div class='line js-file-line' id='LC506'>	bWriteData[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC507'>	bWriteData[<span class="pl-c1">1</span>] = 0xc7;<span class="pl-c"><span class="pl-c">//</span>0xD8;        //Block Erase</span></div><div class='line js-file-line' id='LC508'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, bWriteData, <span class="pl-c1">2</span>);</div><div class='line js-file-line' id='LC509'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, &amp;bWriteData1, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC510'><br></div><div class='line js-file-line' id='LC511'>	<span class="pl-c1">udelay</span>(<span class="pl-c1">100</span>);</div><div class='line js-file-line' id='LC512'>	timeOutCount=<span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC513'>	<span class="pl-k">while</span> ( ( <span class="pl-c1">drvISP_ReadStatus</span>() &amp; 0x01 ) == 0x01 )</div><div class='line js-file-line' id='LC514'>	{</div><div class='line js-file-line' id='LC515'>		timeOutCount++;</div><div class='line js-file-line' id='LC516'>		<span class="pl-k">if</span> ( timeOutCount &gt;= <span class="pl-c1">50000</span> )</div><div class='line js-file-line' id='LC517'>			<span class="pl-k">break</span>; <span class="pl-c"><span class="pl-c">/*</span> around 5 sec timeout <span class="pl-c">*/</span></span></div><div class='line js-file-line' id='LC518'>	}</div><div class='line js-file-line' id='LC519'>}</div><div class='line js-file-line' id='LC520'><br></div><div class='line js-file-line' id='LC521'><span class="pl-k">void</span> <span class="pl-en">drvISP_Program</span>(U16 k, U8* pDataToWrite)</div><div class='line js-file-line' id='LC522'>{</div><div class='line js-file-line' id='LC523'>	U16 i = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC524'>	U16 j = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC525'>	<span class="pl-c"><span class="pl-c">//</span>U16 n = 0;</span></div><div class='line js-file-line' id='LC526'>	U8 TX_data[<span class="pl-c1">133</span>];</div><div class='line js-file-line' id='LC527'>	U8 bWriteData1 = 0x12;</div><div class='line js-file-line' id='LC528'>	U32 addr = k * <span class="pl-c1">1024</span>;</div><div class='line js-file-line' id='LC529'>	U32 timeOutCount = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC530'><br></div><div class='line js-file-line' id='LC531'>	<span class="pl-k">for</span> (j = <span class="pl-c1">0</span>; j &lt; <span class="pl-c1">8</span>; j++)   <span class="pl-c"><span class="pl-c">//</span>256*4 cycle</span></div><div class='line js-file-line' id='LC532'>	{</div><div class='line js-file-line' id='LC533'>		TX_data[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC534'>		TX_data[<span class="pl-c1">1</span>] = 0x02;<span class="pl-c"><span class="pl-c">//</span> Page Program CMD</span></div><div class='line js-file-line' id='LC535'>		TX_data[<span class="pl-c1">2</span>] = (addr + <span class="pl-c1">128</span> * j) &gt;&gt; <span class="pl-c1">16</span>;</div><div class='line js-file-line' id='LC536'>		TX_data[<span class="pl-c1">3</span>] = (addr + <span class="pl-c1">128</span> * j) &gt;&gt; <span class="pl-c1">8</span>;</div><div class='line js-file-line' id='LC537'>		TX_data[<span class="pl-c1">4</span>] = (addr + <span class="pl-c1">128</span> * j);</div><div class='line js-file-line' id='LC538'>		<span class="pl-k">for</span> (i = <span class="pl-c1">0</span>; i &lt; <span class="pl-c1">128</span>; i++)</div><div class='line js-file-line' id='LC539'>		{</div><div class='line js-file-line' id='LC540'>			TX_data[<span class="pl-c1">5</span> + i] = pDataToWrite[j * <span class="pl-c1">128</span> + i];</div><div class='line js-file-line' id='LC541'>		}</div><div class='line js-file-line' id='LC542'><br></div><div class='line js-file-line' id='LC543'>		<span class="pl-c1">udelay</span>(<span class="pl-c1">100</span>);</div><div class='line js-file-line' id='LC544'>		timeOutCount=<span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC545'>		<span class="pl-k">while</span> ( ( <span class="pl-c1">drvISP_ReadStatus</span>() &amp; 0x01 ) == 0x01 )</div><div class='line js-file-line' id='LC546'>		{</div><div class='line js-file-line' id='LC547'>			timeOutCount++;</div><div class='line js-file-line' id='LC548'>			<span class="pl-k">if</span> ( timeOutCount &gt;= <span class="pl-c1">10000</span> )</div><div class='line js-file-line' id='LC549'>				<span class="pl-k">break</span>; <span class="pl-c"><span class="pl-c">/*</span> around 1 sec timeout <span class="pl-c">*/</span></span></div><div class='line js-file-line' id='LC550'>		}</div><div class='line js-file-line' id='LC551'><br></div><div class='line js-file-line' id='LC552'>		<span class="pl-c1">drvISP_WriteEnable</span>();</div><div class='line js-file-line' id='LC553'>		<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, TX_data, <span class="pl-c1">133</span>);   <span class="pl-c"><span class="pl-c">//</span>write 256 byte per cycle</span></div><div class='line js-file-line' id='LC554'>		<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_UPDATE_ADDR_MSG2133, &amp;bWriteData1, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC555'>	}</div><div class='line js-file-line' id='LC556'>}</div><div class='line js-file-line' id='LC557'><br></div><div class='line js-file-line' id='LC558'><span class="pl-k">static</span> <span class="pl-c1">ssize_t</span> <span class="pl-en">firmware_update_show</span>(<span class="pl-k">struct</span> device *dev,</div><div class='line js-file-line' id='LC559'><span class="pl-k">struct</span> device_attribute *attr, <span class="pl-k">char</span> *buf)</div><div class='line js-file-line' id='LC560'>{</div><div class='line js-file-line' id='LC561'>	<span class="pl-k">return</span> <span class="pl-c1">sprintf</span>(buf, <span class="pl-s"><span class="pl-pds">&quot;</span><span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, fw_version);</div><div class='line js-file-line' id='LC562'>}</div><div class='line js-file-line' id='LC563'><br></div><div class='line js-file-line' id='LC564'><br></div><div class='line js-file-line' id='LC565'><span class="pl-k">static</span> <span class="pl-k">void</span> <span class="pl-en">tpd_hw_enable</span>(<span class="pl-k">unsigned</span> <span class="pl-k">int</span> on);</div><div class='line js-file-line' id='LC566'><span class="pl-k">static</span> <span class="pl-k">void</span> <span class="pl-en">tpd_hw_power</span>(<span class="pl-k">unsigned</span> <span class="pl-k">int</span> on);</div><div class='line js-file-line' id='LC567'><span class="pl-k">static</span> <span class="pl-c1">ssize_t</span> <span class="pl-en">firmware_update_store</span>(<span class="pl-k">struct</span> device *dev,</div><div class='line js-file-line' id='LC568'><span class="pl-k">struct</span> device_attribute *attr, <span class="pl-k">const</span> <span class="pl-k">char</span> *buf, <span class="pl-c1">size_t</span> size)</div><div class='line js-file-line' id='LC569'>{</div><div class='line js-file-line' id='LC570'>	U8 i;</div><div class='line js-file-line' id='LC571'>	U8 dbbus_tx_data[<span class="pl-c1">4</span>];</div><div class='line js-file-line' id='LC572'>	<span class="pl-k">unsigned</span> <span class="pl-k">char</span> dbbus_rx_data[<span class="pl-c1">2</span>] = {<span class="pl-c1">0</span>};</div><div class='line js-file-line' id='LC573'>	<span class="pl-k">int</span> fd;</div><div class='line js-file-line' id='LC574'>	<span class="pl-c"><span class="pl-c">//</span>add mask interrupt</span></div><div class='line js-file-line' id='LC575'>	<span class="pl-c"><span class="pl-c">//</span>update_switch = 1;</span></div><div class='line js-file-line' id='LC576'>	<span class="pl-c1">mt65xx_eint_mask</span>(CUST_EINT_TOUCH_PANEL_NUM);</div><div class='line js-file-line' id='LC577'>	<span class="pl-c1">mt65xx_eint_registration</span>(CUST_EINT_TOUCH_PANEL_NUM, CUST_EINT_TOUCH_PANEL_DEBOUNCE_EN, CUST_EINT_TOUCH_PANEL_POLARITY, 			<span class="pl-c1">NULL</span>, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC578'><br></div><div class='line js-file-line' id='LC579'>	<span class="pl-c1">MSG2133_En_Pin_Out</span>(<span class="pl-c1">0</span>);</div><div class='line js-file-line' id='LC580'>	<span class="pl-c1">mdelay</span>(<span class="pl-c1">10</span>);</div><div class='line js-file-line' id='LC581'>	<span class="pl-c1">MSG2133_En_Pin_Out</span>(<span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC582'>	<span class="pl-c1">mdelay</span>(<span class="pl-c1">300</span>);</div><div class='line js-file-line' id='LC583'>	<span class="pl-c1">drvISP_EntryIspMode</span>();</div><div class='line js-file-line' id='LC584'>	<span class="pl-c1">drvISP_BlockErase</span>(0x00000);</div><div class='line js-file-line' id='LC585'>	<span class="pl-c1">mdelay</span>(<span class="pl-c1">300</span>);</div><div class='line js-file-line' id='LC586'>	<span class="pl-c1">MSG2133_En_Pin_Out</span>(<span class="pl-c1">0</span>);</div><div class='line js-file-line' id='LC587'>	<span class="pl-c1">mdelay</span>(<span class="pl-c1">10</span>);</div><div class='line js-file-line' id='LC588'>	<span class="pl-c1">MSG2133_En_Pin_Out</span>(<span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC589'><br></div><div class='line js-file-line' id='LC590'>	<span class="pl-c1">mdelay</span>(<span class="pl-c1">300</span>);</div><div class='line js-file-line' id='LC591'><br></div><div class='line js-file-line' id='LC592'>#<span class="pl-k">if</span> <span class="pl-c1">1</span></div><div class='line js-file-line' id='LC593'>	<span class="pl-c"><span class="pl-c">//</span> Enable slave&#39;s ISP ECO mode</span></div><div class='line js-file-line' id='LC594'>	<span class="pl-c1">dbbusDWIICEnterSerialDebugMode</span>();</div><div class='line js-file-line' id='LC595'>	<span class="pl-c1">dbbusDWIICStopMCU</span>();</div><div class='line js-file-line' id='LC596'>	<span class="pl-c1">dbbusDWIICIICUseBus</span>();</div><div class='line js-file-line' id='LC597'>	<span class="pl-c1">dbbusDWIICIICReshape</span>();</div><div class='line js-file-line' id='LC598'><br></div><div class='line js-file-line' id='LC599'>	dbbus_tx_data[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC600'>	dbbus_tx_data[<span class="pl-c1">1</span>] = 0x08;</div><div class='line js-file-line' id='LC601'>	dbbus_tx_data[<span class="pl-c1">2</span>] = 0x0c;</div><div class='line js-file-line' id='LC602'>	dbbus_tx_data[<span class="pl-c1">3</span>] = 0x08;</div><div class='line js-file-line' id='LC603'><br></div><div class='line js-file-line' id='LC604'>	<span class="pl-c"><span class="pl-c">//</span> Disable the Watchdog</span></div><div class='line js-file-line' id='LC605'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, dbbus_tx_data, <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC606'><br></div><div class='line js-file-line' id='LC607'><br></div><div class='line js-file-line' id='LC608'>	<span class="pl-c"><span class="pl-c">//</span>Get_Chip_Version();</span></div><div class='line js-file-line' id='LC609'><br></div><div class='line js-file-line' id='LC610'>	dbbus_tx_data[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC611'>	dbbus_tx_data[<span class="pl-c1">1</span>] = 0x11;</div><div class='line js-file-line' id='LC612'>	dbbus_tx_data[<span class="pl-c1">2</span>] = 0xE2;</div><div class='line js-file-line' id='LC613'>	dbbus_tx_data[<span class="pl-c1">3</span>] = 0x00;</div><div class='line js-file-line' id='LC614'><br></div><div class='line js-file-line' id='LC615'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, dbbus_tx_data, <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC616'><br></div><div class='line js-file-line' id='LC617'>	dbbus_tx_data[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC618'>	dbbus_tx_data[<span class="pl-c1">1</span>] = 0x3C;</div><div class='line js-file-line' id='LC619'>	dbbus_tx_data[<span class="pl-c1">2</span>] = 0x60;</div><div class='line js-file-line' id='LC620'>	dbbus_tx_data[<span class="pl-c1">3</span>] = 0x55;</div><div class='line js-file-line' id='LC621'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, dbbus_tx_data, <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC622'>	dbbus_tx_data[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC623'>	dbbus_tx_data[<span class="pl-c1">1</span>] = 0x3C;</div><div class='line js-file-line' id='LC624'>	dbbus_tx_data[<span class="pl-c1">2</span>] = 0x61;</div><div class='line js-file-line' id='LC625'>	dbbus_tx_data[<span class="pl-c1">3</span>] = 0xAA;</div><div class='line js-file-line' id='LC626'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, dbbus_tx_data, <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC627'><br></div><div class='line js-file-line' id='LC628'>	<span class="pl-c"><span class="pl-c">//</span>Stop MCU</span></div><div class='line js-file-line' id='LC629'>	dbbus_tx_data[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC630'>	dbbus_tx_data[<span class="pl-c1">1</span>] = 0x0F;</div><div class='line js-file-line' id='LC631'>	dbbus_tx_data[<span class="pl-c1">2</span>] = 0xE6;</div><div class='line js-file-line' id='LC632'>	dbbus_tx_data[<span class="pl-c1">3</span>] = 0x01;</div><div class='line js-file-line' id='LC633'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, dbbus_tx_data, <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC634'><br></div><div class='line js-file-line' id='LC635'>	<span class="pl-c"><span class="pl-c">//</span>Enable SPI Pad</span></div><div class='line js-file-line' id='LC636'>	dbbus_tx_data[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC637'>	dbbus_tx_data[<span class="pl-c1">1</span>] = 0x1E;</div><div class='line js-file-line' id='LC638'>	dbbus_tx_data[<span class="pl-c1">2</span>] = 0x02;</div><div class='line js-file-line' id='LC639'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, dbbus_tx_data, <span class="pl-c1">3</span>);</div><div class='line js-file-line' id='LC640'>	<span class="pl-c1">HalTscrCReadI2CSeq</span>(FW_ADDR_MSG2133, &amp;dbbus_rx_data[<span class="pl-c1">0</span>], <span class="pl-c1">2</span>);</div><div class='line js-file-line' id='LC641'>	<span class="pl-c1">DBG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>dbbus_rx_data[0]=0x<span class="pl-c1">%x</span><span class="pl-pds">&quot;</span></span>, dbbus_rx_data[<span class="pl-c1">0</span>]);</div><div class='line js-file-line' id='LC642'>	dbbus_tx_data[<span class="pl-c1">3</span>] = (dbbus_rx_data[<span class="pl-c1">0</span>] | 0x20);  <span class="pl-c"><span class="pl-c">//</span>Set Bit 5</span></div><div class='line js-file-line' id='LC643'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, dbbus_tx_data, <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC644'><br></div><div class='line js-file-line' id='LC645'>	dbbus_tx_data[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC646'>	dbbus_tx_data[<span class="pl-c1">1</span>] = 0x1E;</div><div class='line js-file-line' id='LC647'>	dbbus_tx_data[<span class="pl-c1">2</span>] = 0x25;</div><div class='line js-file-line' id='LC648'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, dbbus_tx_data, <span class="pl-c1">3</span>);</div><div class='line js-file-line' id='LC649'>	dbbus_rx_data[<span class="pl-c1">0</span>] = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC650'>	dbbus_rx_data[<span class="pl-c1">1</span>] = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC651'>	<span class="pl-c1">HalTscrCReadI2CSeq</span>(FW_ADDR_MSG2133, &amp;dbbus_rx_data[<span class="pl-c1">0</span>], <span class="pl-c1">2</span>);</div><div class='line js-file-line' id='LC652'>	<span class="pl-c1">DBG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>dbbus_rx_data[0]=0x<span class="pl-c1">%x</span><span class="pl-pds">&quot;</span></span>, dbbus_rx_data[<span class="pl-c1">0</span>]);</div><div class='line js-file-line' id='LC653'>	dbbus_tx_data[<span class="pl-c1">3</span>] = dbbus_rx_data[<span class="pl-c1">0</span>] &amp; 0xFC;  <span class="pl-c"><span class="pl-c">//</span>Clear Bit 1,0</span></div><div class='line js-file-line' id='LC654'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, dbbus_tx_data, <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC655'><br></div><div class='line js-file-line' id='LC656'>	<span class="pl-c"><span class="pl-c">//</span>WP overwrite</span></div><div class='line js-file-line' id='LC657'>	dbbus_tx_data[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC658'>	dbbus_tx_data[<span class="pl-c1">1</span>] = 0x1E;</div><div class='line js-file-line' id='LC659'>	dbbus_tx_data[<span class="pl-c1">2</span>] = 0x0E;</div><div class='line js-file-line' id='LC660'>	dbbus_tx_data[<span class="pl-c1">3</span>] = 0x02;</div><div class='line js-file-line' id='LC661'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, dbbus_tx_data, <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC662'><br></div><div class='line js-file-line' id='LC663'>	<span class="pl-c"><span class="pl-c">//</span>set pin high</span></div><div class='line js-file-line' id='LC664'>	dbbus_tx_data[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC665'>	dbbus_tx_data[<span class="pl-c1">1</span>] = 0x1E;</div><div class='line js-file-line' id='LC666'>	dbbus_tx_data[<span class="pl-c1">2</span>] = 0x10;</div><div class='line js-file-line' id='LC667'>	dbbus_tx_data[<span class="pl-c1">3</span>] = 0x08;</div><div class='line js-file-line' id='LC668'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, dbbus_tx_data, <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC669'><br></div><div class='line js-file-line' id='LC670'>	<span class="pl-c"><span class="pl-c">//</span>set FRO to 50M</span></div><div class='line js-file-line' id='LC671'>	dbbus_tx_data[<span class="pl-c1">0</span>] = 0x10;</div><div class='line js-file-line' id='LC672'>	dbbus_tx_data[<span class="pl-c1">1</span>] = 0x11;</div><div class='line js-file-line' id='LC673'>	dbbus_tx_data[<span class="pl-c1">2</span>] = 0xE2;</div><div class='line js-file-line' id='LC674'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, dbbus_tx_data, <span class="pl-c1">3</span>);</div><div class='line js-file-line' id='LC675'>	dbbus_rx_data[<span class="pl-c1">0</span>] = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC676'>	dbbus_rx_data[<span class="pl-c1">1</span>] = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC677'>	<span class="pl-c1">HalTscrCReadI2CSeq</span>(FW_ADDR_MSG2133, &amp;dbbus_rx_data[<span class="pl-c1">0</span>], <span class="pl-c1">2</span>);</div><div class='line js-file-line' id='LC678'>	<span class="pl-c"><span class="pl-c">//</span>printk(&quot;dbbus_rx_data[0]=0x%x&quot;, dbbus_rx_data[0]);</span></div><div class='line js-file-line' id='LC679'>	dbbus_tx_data[<span class="pl-c1">3</span>] = dbbus_rx_data[<span class="pl-c1">0</span>] &amp; 0xF7;  <span class="pl-c"><span class="pl-c">//</span>Clear Bit 1,0</span></div><div class='line js-file-line' id='LC680'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(FW_ADDR_MSG2133, dbbus_tx_data, <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC681'><br></div><div class='line js-file-line' id='LC682'>	<span class="pl-c1">dbbusDWIICIICNotUseBus</span>();</div><div class='line js-file-line' id='LC683'>	<span class="pl-c1">dbbusDWIICNotStopMCU</span>();</div><div class='line js-file-line' id='LC684'>	<span class="pl-c1">dbbusDWIICExitSerialDebugMode</span>();</div><div class='line js-file-line' id='LC685'><br></div><div class='line js-file-line' id='LC686'>	<span class="pl-c"><span class="pl-c">//</span>/////////////////////////////////////</span></div><div class='line js-file-line' id='LC687'>	<span class="pl-c"><span class="pl-c">//</span> Start to load firmware</span></div><div class='line js-file-line' id='LC688'>	<span class="pl-c"><span class="pl-c">//</span>/////////////////////////////////////</span></div><div class='line js-file-line' id='LC689'>	<span class="pl-c1">drvISP_EntryIspMode</span>();</div><div class='line js-file-line' id='LC690'>	<span class="pl-c"><span class="pl-c">//</span>drvISP_BlockErase(0x00000);//////zzf</span></div><div class='line js-file-line' id='LC691'>	<span class="pl-c"><span class="pl-c">//</span>DBG(&quot;FwVersion=2&quot;);</span></div><div class='line js-file-line' id='LC692'>	<span class="pl-k">for</span> (i = <span class="pl-c1">0</span>; i &lt; <span class="pl-c1">59</span>; i++)   <span class="pl-c"><span class="pl-c">//</span> total  94 KB : 1 byte per R/W</span></div><div class='line js-file-line' id='LC693'>	{</div><div class='line js-file-line' id='LC694'>		<span class="pl-k">if</span> (download_firmware_buf == <span class="pl-c1">NULL</span>)</div><div class='line js-file-line' id='LC695'>			<span class="pl-k">return</span> <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC696'>		<span class="pl-c1">drvISP_Program</span>(i,&amp;download_firmware_buf[i*<span class="pl-c1">1024</span>]);</div><div class='line js-file-line' id='LC697'>		<span class="pl-c1">mdelay</span>(<span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC698'>	}</div><div class='line js-file-line' id='LC699'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC700'>	<span class="pl-c1">drvISP_ExitIspMode</span>();</div><div class='line js-file-line' id='LC701'>	FwDataCnt = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC702'>	<span class="pl-k">if</span> (download_firmware_buf != <span class="pl-c1">NULL</span>)</div><div class='line js-file-line' id='LC703'>	{</div><div class='line js-file-line' id='LC704'>		<span class="pl-c1">kfree</span>(download_firmware_buf);</div><div class='line js-file-line' id='LC705'>		download_firmware_buf = <span class="pl-c1">NULL</span>;</div><div class='line js-file-line' id='LC706'>	}</div><div class='line js-file-line' id='LC707'><br></div><div class='line js-file-line' id='LC708'>	<span class="pl-c1">MSG2133_En_Pin_Out</span>(<span class="pl-c1">0</span>);</div><div class='line js-file-line' id='LC709'>	<span class="pl-c1">msleep</span>(<span class="pl-c1">100</span>);</div><div class='line js-file-line' id='LC710'>	<span class="pl-c1">MSG2133_En_Pin_Out</span>(<span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC711'>	<span class="pl-c1">msleep</span>(<span class="pl-c1">500</span>);</div><div class='line js-file-line' id='LC712'>	<span class="pl-c"><span class="pl-c">//</span>update_switch = 0;</span></div><div class='line js-file-line' id='LC713'>	<span class="pl-c1">mt65xx_eint_registration</span>(CUST_EINT_TOUCH_PANEL_NUM, CUST_EINT_TOUCH_PANEL_DEBOUNCE_EN, CUST_EINT_POLARITY_HIGH, tpd_eint_interrupt_handler,<span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC714'>	<span class="pl-c1">mt65xx_eint_unmask</span>(CUST_EINT_TOUCH_PANEL_NUM);</div><div class='line js-file-line' id='LC715'><br></div><div class='line js-file-line' id='LC716'><br></div><div class='line js-file-line' id='LC717'>	<span class="pl-k">return</span> size;</div><div class='line js-file-line' id='LC718'>}</div><div class='line js-file-line' id='LC719'><br></div><div class='line js-file-line' id='LC720'><span class="pl-k">static</span> <span class="pl-en">DEVICE_ATTR</span>(update, <span class="pl-c1">0777</span>, firmware_update_show, firmware_update_store);</div><div class='line js-file-line' id='LC721'><br></div><div class='line js-file-line' id='LC722'><span class="pl-k">static</span> <span class="pl-c1">ssize_t</span> <span class="pl-en">firmware_version_show</span>(<span class="pl-k">struct</span> device *dev,</div><div class='line js-file-line' id='LC723'><span class="pl-k">struct</span> device_attribute *attr, <span class="pl-k">char</span> *buf)</div><div class='line js-file-line' id='LC724'>{</div><div class='line js-file-line' id='LC725'>	<span class="pl-k">return</span> <span class="pl-c1">sprintf</span>(buf, <span class="pl-s"><span class="pl-pds">&quot;</span><span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, fw_version);</div><div class='line js-file-line' id='LC726'>}</div><div class='line js-file-line' id='LC727'><br></div><div class='line js-file-line' id='LC728'><span class="pl-k">static</span> <span class="pl-c1">ssize_t</span> <span class="pl-en">firmware_version_store</span>(<span class="pl-k">struct</span> device *dev,</div><div class='line js-file-line' id='LC729'><span class="pl-k">struct</span> device_attribute *attr, <span class="pl-k">const</span> <span class="pl-k">char</span> *buf, <span class="pl-c1">size_t</span> size)</div><div class='line js-file-line' id='LC730'>{</div><div class='line js-file-line' id='LC731'>	<span class="pl-k">unsigned</span> <span class="pl-k">char</span> dbbus_tx_data[<span class="pl-c1">3</span>];</div><div class='line js-file-line' id='LC732'>	<span class="pl-k">unsigned</span> <span class="pl-k">char</span> dbbus_rx_data[<span class="pl-c1">4</span>] ;</div><div class='line js-file-line' id='LC733'>	<span class="pl-k">unsigned</span> <span class="pl-k">short</span> <span class="pl-c1">major</span>=<span class="pl-c1">0</span>, <span class="pl-c1">minor</span>=<span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC734'>	fw_version = <span class="pl-c1">kzalloc</span>(<span class="pl-k">sizeof</span>(<span class="pl-k">char</span>), GFP_KERNEL);</div><div class='line js-file-line' id='LC735'><br></div><div class='line js-file-line' id='LC736'>	<span class="pl-c"><span class="pl-c">//</span>Get_Chip_Version();</span></div><div class='line js-file-line' id='LC737'>	dbbus_tx_data[<span class="pl-c1">0</span>] = 0x53;</div><div class='line js-file-line' id='LC738'>	dbbus_tx_data[<span class="pl-c1">1</span>] = 0x00;</div><div class='line js-file-line' id='LC739'>	dbbus_tx_data[<span class="pl-c1">2</span>] = 0x74;</div><div class='line js-file-line' id='LC740'>	<span class="pl-c1">HalTscrCDevWriteI2CSeq</span>(TOUCH_ADDR_MSG21XX, &amp;dbbus_tx_data[<span class="pl-c1">0</span>], <span class="pl-c1">3</span>);</div><div class='line js-file-line' id='LC741'>	<span class="pl-c1">HalTscrCReadI2CSeq</span>(TOUCH_ADDR_MSG21XX, &amp;dbbus_rx_data[<span class="pl-c1">0</span>], <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC742'>	<span class="pl-c1">major</span> = (dbbus_rx_data[<span class="pl-c1">1</span>]&lt;&lt;<span class="pl-c1">8</span>)+dbbus_rx_data[<span class="pl-c1">0</span>];</div><div class='line js-file-line' id='LC743'>	<span class="pl-c1">minor</span> = (dbbus_rx_data[<span class="pl-c1">3</span>]&lt;&lt;<span class="pl-c1">8</span>)+dbbus_rx_data[<span class="pl-c1">2</span>];</div><div class='line js-file-line' id='LC744'>	<span class="pl-c1">DBG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>***major = <span class="pl-c1">%d</span> ***<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, <span class="pl-c1">major</span>);</div><div class='line js-file-line' id='LC745'>	<span class="pl-c1">DBG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>***minor = <span class="pl-c1">%d</span> ***<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, <span class="pl-c1">minor</span>);</div><div class='line js-file-line' id='LC746'>	<span class="pl-c1">sprintf</span>(fw_version,<span class="pl-s"><span class="pl-pds">&quot;</span><span class="pl-c1">%03d%03d</span><span class="pl-pds">&quot;</span></span>, <span class="pl-c1">major</span>, <span class="pl-c1">minor</span>);</div><div class='line js-file-line' id='LC747'>	<span class="pl-c1">DBG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>***fw_version = <span class="pl-c1">%s</span> ***<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, fw_version);</div><div class='line js-file-line' id='LC748'><br></div><div class='line js-file-line' id='LC749'>	<span class="pl-k">return</span> size;</div><div class='line js-file-line' id='LC750'><br></div><div class='line js-file-line' id='LC751'>}</div><div class='line js-file-line' id='LC752'><span class="pl-k">static</span> <span class="pl-en">DEVICE_ATTR</span>(version, <span class="pl-c1">0777</span>, firmware_version_show, firmware_version_store);</div><div class='line js-file-line' id='LC753'><br></div><div class='line js-file-line' id='LC754'><br></div><div class='line js-file-line' id='LC755'><span class="pl-k">static</span> <span class="pl-c1">ssize_t</span> <span class="pl-en">firmware_data_show</span>(<span class="pl-k">struct</span> device *dev,</div><div class='line js-file-line' id='LC756'><span class="pl-k">struct</span> device_attribute *attr, <span class="pl-k">char</span> *buf)</div><div class='line js-file-line' id='LC757'>{</div><div class='line js-file-line' id='LC758'>	<span class="pl-k">return</span> FwDataCnt;</div><div class='line js-file-line' id='LC759'>}</div><div class='line js-file-line' id='LC760'><br></div><div class='line js-file-line' id='LC761'><span class="pl-k">static</span> <span class="pl-c1">ssize_t</span> <span class="pl-en">firmware_data_store</span>(<span class="pl-k">struct</span> device *dev,</div><div class='line js-file-line' id='LC762'><span class="pl-k">struct</span> device_attribute *attr, <span class="pl-k">const</span> <span class="pl-k">char</span> *buf, <span class="pl-c1">size_t</span> size)</div><div class='line js-file-line' id='LC763'>{</div><div class='line js-file-line' id='LC764'>	<span class="pl-c1">DBG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>***FwDataCnt = <span class="pl-c1">%d</span> ***<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, FwDataCnt);</div><div class='line js-file-line' id='LC765'>	<span class="pl-k">int</span> i;</div><div class='line js-file-line' id='LC766'>	<span class="pl-k">if</span> (download_firmware_buf == <span class="pl-c1">NULL</span>) {</div><div class='line js-file-line' id='LC767'>		download_firmware_buf = <span class="pl-c1">kzalloc</span>(DOWNLOAD_FIRMWARE_BUF_SIZE, GFP_KERNEL);</div><div class='line js-file-line' id='LC768'>		<span class="pl-k">if</span> (download_firmware_buf == <span class="pl-c1">NULL</span>)</div><div class='line js-file-line' id='LC769'>			<span class="pl-k">return</span> <span class="pl-c1">NULL</span>;</div><div class='line js-file-line' id='LC770'>	}</div><div class='line js-file-line' id='LC771'>	<span class="pl-k">if</span>(FwDataCnt&lt;<span class="pl-c1">59</span>)</div><div class='line js-file-line' id='LC772'>	{</div><div class='line js-file-line' id='LC773'>		<span class="pl-c1">memcpy</span>(&amp;download_firmware_buf[FwDataCnt*<span class="pl-c1">1024</span>], buf, <span class="pl-c1">1024</span>);</div><div class='line js-file-line' id='LC774'>	}</div><div class='line js-file-line' id='LC775'>	FwDataCnt++;</div><div class='line js-file-line' id='LC776'>	<span class="pl-k">return</span> size;</div><div class='line js-file-line' id='LC777'>}</div><div class='line js-file-line' id='LC778'><span class="pl-k">static</span> <span class="pl-en">DEVICE_ATTR</span>(data, <span class="pl-c1">0777</span>, firmware_data_show, firmware_data_store);</div><div class='line js-file-line' id='LC779'><br></div><div class='line js-file-line' id='LC780'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC781'><br></div><div class='line js-file-line' id='LC782'><br></div><div class='line js-file-line' id='LC783'><br></div><div class='line js-file-line' id='LC784'><br></div><div class='line js-file-line' id='LC785'><br></div><div class='line js-file-line' id='LC786'>#<span class="pl-k">ifdef</span> TP_PROXIMITY_SENSOR</div><div class='line js-file-line' id='LC787'><span class="pl-k">static</span> <span class="pl-c1">ssize_t</span> <span class="pl-en">show_proximity_sensor</span>(<span class="pl-k">struct</span> device *dev, <span class="pl-k">struct</span> device_attribute *attr, <span class="pl-k">char</span> *buf)</div><div class='line js-file-line' id='LC788'>{</div><div class='line js-file-line' id='LC789'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">static</span> <span class="pl-k">char</span> temp=<span class="pl-c1">2</span>;</div><div class='line js-file-line' id='LC790'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span> (buf != <span class="pl-c1">NULL</span>)</div><div class='line js-file-line' id='LC791'>	    *buf = ps_data_state[<span class="pl-c1">0</span>];</div><div class='line js-file-line' id='LC792'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(temp!=*buf)</div><div class='line js-file-line' id='LC793'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC794'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>proximity_sensor_show: buf=<span class="pl-c1">%d</span><span class="pl-cce">\n\n</span><span class="pl-pds">&quot;</span></span>, *buf);</div><div class='line js-file-line' id='LC795'>&nbsp;&nbsp;&nbsp;&nbsp;temp=*buf;</div><div class='line js-file-line' id='LC796'>&nbsp;&nbsp;&nbsp;&nbsp;}    <span class="pl-k">return</span> <span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC797'>}</div><div class='line js-file-line' id='LC798'><br></div><div class='line js-file-line' id='LC799'><span class="pl-k">static</span> <span class="pl-c1">ssize_t</span> <span class="pl-en">store_proximity_sensor</span>(<span class="pl-k">struct</span> device *dev, <span class="pl-k">struct</span> device_attribute *attr, <span class="pl-k">const</span> <span class="pl-k">char</span> *buf, <span class="pl-c1">size_t</span> size)</div><div class='line js-file-line' id='LC800'>{</div><div class='line js-file-line' id='LC801'>&nbsp;&nbsp;&nbsp;&nbsp;U8 ps_store_data[<span class="pl-c1">4</span>];</div><div class='line js-file-line' id='LC802'><br></div><div class='line js-file-line' id='LC803'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(buf != <span class="pl-c1">NULL</span> &amp;&amp; size != <span class="pl-c1">0</span>)</div><div class='line js-file-line' id='LC804'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC805'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(DISABLE_CTP_PS == *buf)</div><div class='line js-file-line' id='LC806'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC807'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>DISABLE_CTP_PS buf=<span class="pl-c1">%d</span>,size=<span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, *buf, size);</div><div class='line js-file-line' id='LC808'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps_store_data[<span class="pl-c1">0</span>] = 0x52;</div><div class='line js-file-line' id='LC809'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps_store_data[<span class="pl-c1">1</span>] = 0x00;</div><div class='line js-file-line' id='LC810'>	    ps_store_data[<span class="pl-c1">2</span>] = 0x62;</div><div class='line js-file-line' id='LC811'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps_store_data[<span class="pl-c1">3</span>] = 0xa1;</div><div class='line js-file-line' id='LC812'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">i2c_write</span>(TOUCH_ADDR_MSG20XX, &amp;ps_store_data[<span class="pl-c1">0</span>], <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC813'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">msleep</span>(<span class="pl-c1">2000</span>);</div><div class='line js-file-line' id='LC814'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>RESET_CTP_PS buf=<span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, *buf);</div><div class='line js-file-line' id='LC815'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt65xx_eint_mask</span>(CUST_EINT_TOUCH_PANEL_NUM);</div><div class='line js-file-line' id='LC816'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_mode</span>(GPIO_CTP_RST_PIN, GPIO_CTP_RST_PIN_M_GPIO);</div><div class='line js-file-line' id='LC817'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_dir</span>(GPIO_CTP_RST_PIN, GPIO_DIR_OUT);</div><div class='line js-file-line' id='LC818'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_out</span>(GPIO_CTP_RST_PIN, GPIO_OUT_ZERO);</div><div class='line js-file-line' id='LC819'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">msleep</span>(<span class="pl-c1">100</span>);</div><div class='line js-file-line' id='LC820'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_mode</span>(GPIO_CTP_RST_PIN, GPIO_CTP_RST_PIN_M_GPIO);</div><div class='line js-file-line' id='LC821'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_dir</span>(GPIO_CTP_RST_PIN, GPIO_DIR_OUT);</div><div class='line js-file-line' id='LC822'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_out</span>(GPIO_CTP_RST_PIN, GPIO_OUT_ONE);</div><div class='line js-file-line' id='LC823'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mdelay</span>(<span class="pl-c1">500</span>);</div><div class='line js-file-line' id='LC824'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt65xx_eint_unmask</span>(CUST_EINT_TOUCH_PANEL_NUM);</div><div class='line js-file-line' id='LC825'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC826'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">else</span> <span class="pl-k">if</span>(ENABLE_CTP_PS == *buf)</div><div class='line js-file-line' id='LC827'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC828'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>ENABLE_CTP_PS buf=<span class="pl-c1">%d</span>,size=<span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, *buf, size);</div><div class='line js-file-line' id='LC829'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps_store_data[<span class="pl-c1">0</span>] = 0x52;</div><div class='line js-file-line' id='LC830'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps_store_data[<span class="pl-c1">1</span>] = 0x00;</div><div class='line js-file-line' id='LC831'>			ps_store_data[<span class="pl-c1">2</span>] = 0x62;</div><div class='line js-file-line' id='LC832'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps_store_data[<span class="pl-c1">3</span>] = 0xa0;</div><div class='line js-file-line' id='LC833'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">i2c_write</span>(TOUCH_ADDR_MSG20XX, &amp;ps_store_data[<span class="pl-c1">0</span>], <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC834'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC835'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tp_proximity_state = *buf;</div><div class='line js-file-line' id='LC836'>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC837'><br></div><div class='line js-file-line' id='LC838'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> size;</div><div class='line js-file-line' id='LC839'>}</div><div class='line js-file-line' id='LC840'><span class="pl-k">static</span> <span class="pl-en">DEVICE_ATTR</span>(proximity_sensor, <span class="pl-c1">0777</span>, show_proximity_sensor, store_proximity_sensor);</div><div class='line js-file-line' id='LC841'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC842'><span class="pl-c"><span class="pl-c">//</span>//////////////////////////////////////////////////////////////////////////////////////////add by lan</span></div><div class='line js-file-line' id='LC843'>#<span class="pl-k">ifdef</span> TPD_PROXIMITY</div><div class='line js-file-line' id='LC844'><br></div><div class='line js-file-line' id='LC845'><span class="pl-k">void</span> <span class="pl-en">i2c_write</span>(u8 addr, u8* data, u16 size)</div><div class='line js-file-line' id='LC846'>{</div><div class='line js-file-line' id='LC847'>	u8 addr_bak;</div><div class='line js-file-line' id='LC848'><br></div><div class='line js-file-line' id='LC849'>	addr_bak = i2c_client-&gt;addr;</div><div class='line js-file-line' id='LC850'>	i2c_client-&gt;addr = addr;</div><div class='line js-file-line' id='LC851'>	i2c_client-&gt;addr |= I2C_ENEXT_FLAG;</div><div class='line js-file-line' id='LC852'>	<span class="pl-c1">i2c_master_send</span>(i2c_client,data,size);</div><div class='line js-file-line' id='LC853'>	i2c_client-&gt;addr = addr_bak;</div><div class='line js-file-line' id='LC854'>}</div><div class='line js-file-line' id='LC855'><br></div><div class='line js-file-line' id='LC856'><span class="pl-k">int</span> <span class="pl-en">tpd_read_ps</span>(<span class="pl-k">void</span>)</div><div class='line js-file-line' id='LC857'>{</div><div class='line js-file-line' id='LC858'>	tpd_proximity_detect;</div><div class='line js-file-line' id='LC859'>	<span class="pl-k">return</span> <span class="pl-c1">0</span>;    </div><div class='line js-file-line' id='LC860'>}</div><div class='line js-file-line' id='LC861'><br></div><div class='line js-file-line' id='LC862'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">tpd_get_ps_value</span>(<span class="pl-k">void</span>)</div><div class='line js-file-line' id='LC863'>{</div><div class='line js-file-line' id='LC864'>	<span class="pl-k">return</span> tpd_proximity_detect;</div><div class='line js-file-line' id='LC865'>}</div><div class='line js-file-line' id='LC866'><br></div><div class='line js-file-line' id='LC867'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">tpd_enable_ps</span>(<span class="pl-k">int</span> enable)</div><div class='line js-file-line' id='LC868'>{</div><div class='line js-file-line' id='LC869'>	u8 ps_store_data[<span class="pl-c1">4</span>];</div><div class='line js-file-line' id='LC870'>	<span class="pl-k">if</span> (enable)</div><div class='line js-file-line' id='LC871'>	{</div><div class='line js-file-line' id='LC872'>		ps_store_data[<span class="pl-c1">0</span>] = 0x52;</div><div class='line js-file-line' id='LC873'>		ps_store_data[<span class="pl-c1">1</span>] = 0x00;</div><div class='line js-file-line' id='LC874'>		ps_store_data[<span class="pl-c1">2</span>] = 0x62;</div><div class='line js-file-line' id='LC875'>		ps_store_data[<span class="pl-c1">3</span>] = 0xa0;<span class="pl-c"><span class="pl-c">//</span>0xa2//0xa4</span></div><div class='line js-file-line' id='LC876'>		tpd_proximity_flag = <span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC877'>		<span class="pl-c1">TPD_PROXIMITY_DEBUG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>xxxxx mycat tpd_enable_ps function is on<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC878'>	}</div><div class='line js-file-line' id='LC879'>	<span class="pl-k">else</span></div><div class='line js-file-line' id='LC880'>	{</div><div class='line js-file-line' id='LC881'>		ps_store_data[<span class="pl-c1">0</span>] = 0x52;</div><div class='line js-file-line' id='LC882'>		ps_store_data[<span class="pl-c1">1</span>] = 0x00;</div><div class='line js-file-line' id='LC883'>		ps_store_data[<span class="pl-c1">2</span>] = 0x62;</div><div class='line js-file-line' id='LC884'>		ps_store_data[<span class="pl-c1">3</span>] = 0xa1;</div><div class='line js-file-line' id='LC885'>		tpd_proximity_flag = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC886'>		<span class="pl-c1">TPD_PROXIMITY_DEBUG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>xxxxx mycat tpd_enable_ps function is off<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC887'>	}</div><div class='line js-file-line' id='LC888'>	<span class="pl-c1">i2c_write</span>(TOUCH_ADDR_MSG21XX, &amp;ps_store_data[<span class="pl-c1">0</span>], <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC889'>	<span class="pl-k">return</span> <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC890'>}</div><div class='line js-file-line' id='LC891'><br></div><div class='line js-file-line' id='LC892'><br></div><div class='line js-file-line' id='LC893'><span class="pl-k">static</span> <span class="pl-c1">ssize_t</span> <span class="pl-en">show_proximity_sensor</span>(<span class="pl-k">struct</span> device *dev, <span class="pl-k">struct</span> device_attribute *attr, <span class="pl-k">char</span> *buf)</div><div class='line js-file-line' id='LC894'>{</div><div class='line js-file-line' id='LC895'>	<span class="pl-k">static</span> <span class="pl-k">char</span> temp=<span class="pl-c1">2</span>;</div><div class='line js-file-line' id='LC896'>	<span class="pl-k">int</span> err = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC897'><span class="pl-k">if</span>((err = <span class="pl-c1">tpd_read_ps</span>()))</div><div class='line js-file-line' id='LC898'>{</div><div class='line js-file-line' id='LC899'>	err = -<span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC900'>	<span class="pl-k">return</span> err;</div><div class='line js-file-line' id='LC901'>}</div><div class='line js-file-line' id='LC902'><span class="pl-k">else</span></div><div class='line js-file-line' id='LC903'>{</div><div class='line js-file-line' id='LC904'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span> (buf != <span class="pl-c1">NULL</span>)</div><div class='line js-file-line' id='LC905'>	    *buf = <span class="pl-c1">tpd_get_ps_value</span>();</div><div class='line js-file-line' id='LC906'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(temp!=*buf)</div><div class='line js-file-line' id='LC907'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC908'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>xxxxx mycat proximity_sensor_show: buf=<span class="pl-c1">%d</span><span class="pl-cce">\n\n</span><span class="pl-pds">&quot;</span></span>, *buf);</div><div class='line js-file-line' id='LC909'>&nbsp;&nbsp;&nbsp;&nbsp;temp=*buf;</div><div class='line js-file-line' id='LC910'>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC911'>	<span class="pl-k">return</span> <span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC912'>}</div><div class='line js-file-line' id='LC913'><br></div><div class='line js-file-line' id='LC914'>}</div><div class='line js-file-line' id='LC915'><br></div><div class='line js-file-line' id='LC916'><span class="pl-k">static</span> <span class="pl-c1">ssize_t</span> <span class="pl-en">store_proximity_sensor</span>(<span class="pl-k">struct</span> device *dev, <span class="pl-k">struct</span> device_attribute *attr, <span class="pl-k">const</span> <span class="pl-k">char</span> *buf, <span class="pl-c1">size_t</span> size)</div><div class='line js-file-line' id='LC917'>{</div><div class='line js-file-line' id='LC918'><br></div><div class='line js-file-line' id='LC919'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(buf != <span class="pl-c1">NULL</span> &amp;&amp; size != <span class="pl-c1">0</span>)</div><div class='line js-file-line' id='LC920'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC921'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(DISABLE_CTP_PS == *buf)</div><div class='line js-file-line' id='LC922'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC923'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div class='line js-file-line' id='LC924'>		<span class="pl-k">if</span>((<span class="pl-c1">tpd_enable_ps</span>(<span class="pl-c1">0</span>) != <span class="pl-c1">0</span>))</div><div class='line js-file-line' id='LC925'>			{</div><div class='line js-file-line' id='LC926'>			<span class="pl-c1">APS_ERR</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>enable ps fail: <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>); </div><div class='line js-file-line' id='LC927'>			<span class="pl-k">return</span> -<span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC928'>			}</div><div class='line js-file-line' id='LC929'><br></div><div class='line js-file-line' id='LC930'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC931'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">else</span> <span class="pl-k">if</span>(ENABLE_CTP_PS == *buf)</div><div class='line js-file-line' id='LC932'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC933'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div class='line js-file-line' id='LC934'>		<span class="pl-k">if</span>((<span class="pl-c1">tpd_enable_ps</span>(<span class="pl-c1">1</span>) != <span class="pl-c1">0</span>))</div><div class='line js-file-line' id='LC935'>			{</div><div class='line js-file-line' id='LC936'>			<span class="pl-c1">APS_ERR</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>disable ps fail: <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>); </div><div class='line js-file-line' id='LC937'>			<span class="pl-k">return</span> -<span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC938'>			}</div><div class='line js-file-line' id='LC939'><br></div><div class='line js-file-line' id='LC940'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC941'><br></div><div class='line js-file-line' id='LC942'><br></div><div class='line js-file-line' id='LC943'>	<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>xxxxx mycat tpd_proximity_state_on_off: buf=<span class="pl-c1">%d</span><span class="pl-cce">\n\n</span><span class="pl-pds">&quot;</span></span>, *buf);</div><div class='line js-file-line' id='LC944'>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC945'><br></div><div class='line js-file-line' id='LC946'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> size;</div><div class='line js-file-line' id='LC947'>}</div><div class='line js-file-line' id='LC948'><span class="pl-k">static</span> <span class="pl-en">DEVICE_ATTR</span>(proximity_sensor, <span class="pl-c1">0777</span>, show_proximity_sensor, store_proximity_sensor);</div><div class='line js-file-line' id='LC949'><br></div><div class='line js-file-line' id='LC950'><br></div><div class='line js-file-line' id='LC951'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC952'><span class="pl-c"><span class="pl-c">//</span>//////////////////////////////////////////////////////////////////////////////////////////////////////////</span></div><div class='line js-file-line' id='LC953'><br></div><div class='line js-file-line' id='LC954'><br></div><div class='line js-file-line' id='LC955'><br></div><div class='line js-file-line' id='LC956'><span class="pl-k">static</span> <span class="pl-k">void</span> <span class="pl-en">tpd_down</span>(<span class="pl-k">int</span> x, <span class="pl-k">int</span> y)</div><div class='line js-file-line' id='LC957'>{</div><div class='line js-file-line' id='LC958'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">input_report_abs</span>(tpd-&gt;dev, ABS_PRESSURE, <span class="pl-c1">128</span>);</div><div class='line js-file-line' id='LC959'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">input_report_key</span>(tpd-&gt;dev, BTN_TOUCH, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC960'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">input_report_abs</span>(tpd-&gt;dev, ABS_MT_TOUCH_MAJOR, <span class="pl-c1">128</span>);</div><div class='line js-file-line' id='LC961'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">input_report_abs</span>(tpd-&gt;dev, ABS_MT_WIDTH_MAJOR, <span class="pl-c1">128</span>);</div><div class='line js-file-line' id='LC962'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">input_report_abs</span>(tpd-&gt;dev, ABS_MT_POSITION_X, x);</div><div class='line js-file-line' id='LC963'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">input_report_abs</span>(tpd-&gt;dev, ABS_MT_POSITION_Y, y);</div><div class='line js-file-line' id='LC964'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">input_mt_sync</span>(tpd-&gt;dev);</div><div class='line js-file-line' id='LC965'><span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>MSG2133 D[<span class="pl-c1">%4d</span> <span class="pl-c1">%4d</span> <span class="pl-c1">%4d</span>] <span class="pl-pds">&quot;</span></span>, x, y,<span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC966'><br></div><div class='line js-file-line' id='LC967'><span class="pl-k">if</span> (FACTORY_BOOT == <span class="pl-c1">get_boot_mode</span>()|| RECOVERY_BOOT == <span class="pl-c1">get_boot_mode</span>())</div><div class='line js-file-line' id='LC968'>{ </div><div class='line js-file-line' id='LC969'>#<span class="pl-k">ifdef</span> TPD_HAVE_BUTTON</div><div class='line js-file-line' id='LC970'><span class="pl-c1">tpd_button</span>(x,y,<span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC971'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC972'><span class="pl-k">if</span>(y &gt; TPD_RES_Y) <span class="pl-c"><span class="pl-c">//</span>virtual key debounce to avoid android ANR issue</span></div><div class='line js-file-line' id='LC973'>{</div><div class='line js-file-line' id='LC974'><span class="pl-c1">msleep</span>(<span class="pl-c1">50</span>);</div><div class='line js-file-line' id='LC975'><span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>D virtual key <span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC976'>}</div><div class='line js-file-line' id='LC977'>}</div><div class='line js-file-line' id='LC978'>}</div><div class='line js-file-line' id='LC979'><br></div><div class='line js-file-line' id='LC980'><span class="pl-k">static</span> <span class="pl-k">void</span> <span class="pl-en">tpd_up</span>(<span class="pl-k">int</span> x, <span class="pl-k">int</span> y)</div><div class='line js-file-line' id='LC981'>{</div><div class='line js-file-line' id='LC982'><span class="pl-c1">input_report_abs</span>(tpd-&gt;dev, ABS_PRESSURE, <span class="pl-c1">0</span>);</div><div class='line js-file-line' id='LC983'><span class="pl-c1">input_report_key</span>(tpd-&gt;dev, BTN_TOUCH, <span class="pl-c1">0</span>);</div><div class='line js-file-line' id='LC984'><span class="pl-c1">input_report_abs</span>(tpd-&gt;dev, ABS_MT_TOUCH_MAJOR, <span class="pl-c1">0</span>);</div><div class='line js-file-line' id='LC985'><span class="pl-c1">input_report_abs</span>(tpd-&gt;dev, ABS_MT_WIDTH_MAJOR, <span class="pl-c1">0</span>);</div><div class='line js-file-line' id='LC986'><span class="pl-c1">input_report_abs</span>(tpd-&gt;dev, ABS_MT_POSITION_X, x);</div><div class='line js-file-line' id='LC987'><span class="pl-c1">input_report_abs</span>(tpd-&gt;dev, ABS_MT_POSITION_Y, y);</div><div class='line js-file-line' id='LC988'><span class="pl-c1">input_mt_sync</span>(tpd-&gt;dev);</div><div class='line js-file-line' id='LC989'><span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>MSG2133 U[<span class="pl-c1">%4d</span> <span class="pl-c1">%4d</span> <span class="pl-c1">%4d</span>] <span class="pl-pds">&quot;</span></span>, x, y, <span class="pl-c1">0</span>);</div><div class='line js-file-line' id='LC990'><br></div><div class='line js-file-line' id='LC991'><span class="pl-k">if</span> (FACTORY_BOOT == <span class="pl-c1">get_boot_mode</span>()|| RECOVERY_BOOT == <span class="pl-c1">get_boot_mode</span>())</div><div class='line js-file-line' id='LC992'>{</div><div class='line js-file-line' id='LC993'>#<span class="pl-k">ifdef</span> TPD_HAVE_BUTTON</div><div class='line js-file-line' id='LC994'><span class="pl-c1">tpd_button</span>(x,y,<span class="pl-c1">0</span>);</div><div class='line js-file-line' id='LC995'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC996'>} </div><div class='line js-file-line' id='LC997'>}</div><div class='line js-file-line' id='LC998'><br></div><div class='line js-file-line' id='LC999'><span class="pl-k">unsigned</span> <span class="pl-k">char</span> <span class="pl-en">tpd_check_sum</span>(<span class="pl-k">unsigned</span> <span class="pl-k">char</span> *pval)</div><div class='line js-file-line' id='LC1000'>{</div><div class='line js-file-line' id='LC1001'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">int</span> i, sum = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1002'><br></div><div class='line js-file-line' id='LC1003'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">for</span>(i = <span class="pl-c1">0</span>; i &lt; <span class="pl-c1">7</span>; i++)</div><div class='line js-file-line' id='LC1004'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1005'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sum += pval[i];</div><div class='line js-file-line' id='LC1006'>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1007'><br></div><div class='line js-file-line' id='LC1008'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> (<span class="pl-k">unsigned</span> <span class="pl-k">char</span>)((-sum) &amp; 0xFF);</div><div class='line js-file-line' id='LC1009'>}</div><div class='line js-file-line' id='LC1010'><br></div><div class='line js-file-line' id='LC1011'><span class="pl-k">static</span> <span class="pl-k">bool</span> <span class="pl-en">msg2033_i2c_read</span>(<span class="pl-k">char</span> *pbt_buf, <span class="pl-k">int</span> dw_lenth)</div><div class='line js-file-line' id='LC1012'>{</div><div class='line js-file-line' id='LC1013'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">int</span> ret;</div><div class='line js-file-line' id='LC1014'>&nbsp;&nbsp;&nbsp;&nbsp;i2c_client-&gt;addr|=I2C_ENEXT_FLAG;</div><div class='line js-file-line' id='LC1015'><br></div><div class='line js-file-line' id='LC1016'>&nbsp;&nbsp;&nbsp;&nbsp;ret = <span class="pl-c1">i2c_master_recv</span>(i2c_client, pbt_buf, dw_lenth);</div><div class='line js-file-line' id='LC1017'><br></div><div class='line js-file-line' id='LC1018'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(ret &lt;= <span class="pl-c1">0</span>)</div><div class='line js-file-line' id='LC1019'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1020'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>MYCAT msg_i2c_read_interface error ret=<span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>,ret);</div><div class='line js-file-line' id='LC1021'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> <span class="pl-c1">false</span>;</div><div class='line js-file-line' id='LC1022'>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1023'><br></div><div class='line js-file-line' id='LC1024'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> <span class="pl-c1">true</span>;</div><div class='line js-file-line' id='LC1025'>}</div><div class='line js-file-line' id='LC1026'><br></div><div class='line js-file-line' id='LC1027'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">tpd_touchinfo</span>(<span class="pl-k">struct</span> touch_info *cinfo)</div><div class='line js-file-line' id='LC1028'>{</div><div class='line js-file-line' id='LC1029'>&nbsp;&nbsp;&nbsp;&nbsp;SHORT_TOUCH_STATE ShortTouchState;</div><div class='line js-file-line' id='LC1030'>&nbsp;&nbsp;&nbsp;&nbsp;BYTE reg_val[<span class="pl-c1">8</span>] = {<span class="pl-c1">0</span>};</div><div class='line js-file-line' id='LC1031'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">int</span>  temp = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1032'>&nbsp;&nbsp;&nbsp;&nbsp;u32 bitmask;</div><div class='line js-file-line' id='LC1033'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">int</span> i;</div><div class='line js-file-line' id='LC1034'>#<span class="pl-k">ifdef</span> TPD_PROXIMITY</div><div class='line js-file-line' id='LC1035'>	<span class="pl-k">int</span> err;</div><div class='line js-file-line' id='LC1036'>	hwm_sensor_data sensor_data;</div><div class='line js-file-line' id='LC1037'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1038'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">msg2033_i2c_read</span>(reg_val, <span class="pl-c1">8</span>);</div><div class='line js-file-line' id='LC1039'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>received raw data from touch panel as following in fun <span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, __func__);</div><div class='line js-file-line' id='LC1040'><br></div><div class='line js-file-line' id='LC1041'>&nbsp;&nbsp;&nbsp;&nbsp;ShortTouchState.<span class="pl-smi">pos_x</span> = ((reg_val[<span class="pl-c1">1</span>] &amp; 0xF0) &lt;&lt; <span class="pl-c1">4</span>) | reg_val[<span class="pl-c1">2</span>];</div><div class='line js-file-line' id='LC1042'>&nbsp;&nbsp;&nbsp;&nbsp;ShortTouchState.<span class="pl-smi">pos_y</span> = ((reg_val[<span class="pl-c1">1</span>] &amp; 0x0F) &lt;&lt; <span class="pl-c1">8</span>) | reg_val[<span class="pl-c1">3</span>];</div><div class='line js-file-line' id='LC1043'>&nbsp;&nbsp;&nbsp;&nbsp;ShortTouchState.<span class="pl-smi">dst_x</span> = ((reg_val[<span class="pl-c1">4</span>] &amp; 0xF0) &lt;&lt; <span class="pl-c1">4</span>) | reg_val[<span class="pl-c1">5</span>];</div><div class='line js-file-line' id='LC1044'>&nbsp;&nbsp;&nbsp;&nbsp;ShortTouchState.<span class="pl-smi">dst_y</span> = ((reg_val[<span class="pl-c1">4</span>] &amp; 0x0F) &lt;&lt; <span class="pl-c1">8</span>) | reg_val[<span class="pl-c1">6</span>];</div><div class='line js-file-line' id='LC1045'><br></div><div class='line js-file-line' id='LC1046'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>((ShortTouchState.<span class="pl-smi">dst_x</span>) &amp; 0x0800)</div><div class='line js-file-line' id='LC1047'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1048'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ShortTouchState.<span class="pl-smi">dst_x</span> |= 0xF000;</div><div class='line js-file-line' id='LC1049'>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1050'><br></div><div class='line js-file-line' id='LC1051'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>((ShortTouchState.<span class="pl-smi">dst_y</span>) &amp; 0x0800)</div><div class='line js-file-line' id='LC1052'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1053'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ShortTouchState.<span class="pl-smi">dst_y</span> |= 0xF000;</div><div class='line js-file-line' id='LC1054'>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1055'><br></div><div class='line js-file-line' id='LC1056'>&nbsp;&nbsp;&nbsp;&nbsp;ShortTouchState.<span class="pl-smi">pos_x2</span> = ShortTouchState.<span class="pl-smi">pos_x</span> + ShortTouchState.<span class="pl-smi">dst_x</span>;</div><div class='line js-file-line' id='LC1057'>&nbsp;&nbsp;&nbsp;&nbsp;ShortTouchState.<span class="pl-smi">pos_y2</span> = ShortTouchState.<span class="pl-smi">pos_y</span> + ShortTouchState.<span class="pl-smi">dst_y</span>;</div><div class='line js-file-line' id='LC1058'><br></div><div class='line js-file-line' id='LC1059'>&nbsp;&nbsp;&nbsp;&nbsp;temp = <span class="pl-c1">tpd_check_sum</span>(reg_val);</div><div class='line js-file-line' id='LC1060'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>check_sum=<span class="pl-c1">%d</span>,reg_val_7=<span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, temp, reg_val[<span class="pl-c1">7</span>]);</div><div class='line js-file-line' id='LC1061'><br></div><div class='line js-file-line' id='LC1062'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(temp == reg_val[<span class="pl-c1">7</span>])</div><div class='line js-file-line' id='LC1063'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1064'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>TP_PS <span class="pl-cce">\n</span>reg_val[1]=0x<span class="pl-c1">%x</span><span class="pl-cce">\n</span>reg_val[2]=0x<span class="pl-c1">%x</span><span class="pl-cce">\n</span>reg_val[3]=0x<span class="pl-c1">%x</span><span class="pl-cce">\n</span>reg_val[4]=0x<span class="pl-c1">%x</span><span class="pl-cce">\n</span>reg_val[5]=0x<span class="pl-c1">%x</span><span class="pl-cce">\n</span>reg_val[6]=0x<span class="pl-c1">%x</span><span class="pl-cce">\n</span>reg_val[7]=0x<span class="pl-c1">%x</span> by cheehwa<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, reg_val[<span class="pl-c1">1</span>], reg_val[<span class="pl-c1">2</span>], reg_val[<span class="pl-c1">3</span>], reg_val[<span class="pl-c1">4</span>], reg_val[<span class="pl-c1">5</span>], reg_val[<span class="pl-c1">6</span>], reg_val[<span class="pl-c1">7</span>]);</div><div class='line js-file-line' id='LC1065'><br></div><div class='line js-file-line' id='LC1066'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(reg_val[<span class="pl-c1">0</span>] == 0x52) <span class="pl-c"><span class="pl-c">//</span>CTP  ID</span></div><div class='line js-file-line' id='LC1067'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1068'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div class='line js-file-line' id='LC1069'><br></div><div class='line js-file-line' id='LC1070'>#<span class="pl-k">if</span> (defined(TPD_HAVE_BUTTON) &amp;&amp; !defined(SIMULATED_BUTTON))</div><div class='line js-file-line' id='LC1071'>	     <span class="pl-k">if</span>(reg_val[<span class="pl-c1">1</span>] == 0xFF &amp;&amp; reg_val[<span class="pl-c1">2</span>] == 0xFF&amp;&amp; reg_val[<span class="pl-c1">3</span>] == 0xFF&amp;&amp; reg_val[<span class="pl-c1">4</span>] == 0xFF&amp;&amp; reg_val[<span class="pl-c1">6</span>] == 0xFF)</div><div class='line js-file-line' id='LC1072'>	     {</div><div class='line js-file-line' id='LC1073'>		 	<span class="pl-k">if</span>(reg_val[<span class="pl-c1">5</span>] == 0x0||reg_val[<span class="pl-c1">5</span>] == 0xFF)</div><div class='line js-file-line' id='LC1074'>			{</div><div class='line js-file-line' id='LC1075'>				i = TPD_KEY_COUNT;</div><div class='line js-file-line' id='LC1076'>			}</div><div class='line js-file-line' id='LC1077'>		#<span class="pl-k">ifdef</span> TP_PROXIMITY_SENSOR</div><div class='line js-file-line' id='LC1078'>				<span class="pl-k">else</span> <span class="pl-k">if</span>(reg_val[<span class="pl-c1">5</span>] == 0x80) <span class="pl-c"><span class="pl-c">//</span> close to</span></div><div class='line js-file-line' id='LC1079'>				{</div><div class='line js-file-line' id='LC1080'>					<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>TP_PROXIMITY_SENSOR VVV by cheehwa<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1081'>					ps_data_state[<span class="pl-c1">0</span>] = <span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC1082'>				}</div><div class='line js-file-line' id='LC1083'>				<span class="pl-k">else</span> <span class="pl-k">if</span>(reg_val[<span class="pl-c1">5</span>] == 0x40) <span class="pl-c"><span class="pl-c">//</span> leave</span></div><div class='line js-file-line' id='LC1084'>				{</div><div class='line js-file-line' id='LC1085'>					<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>TP_PROXIMITY_SENSOR XXX by cheehwa<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1086'>					ps_data_state[<span class="pl-c1">0</span>] = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1087'>				}</div><div class='line js-file-line' id='LC1088'>		#<span class="pl-k">endif</span>				</div><div class='line js-file-line' id='LC1089'>			<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1090'>			{</div><div class='line js-file-line' id='LC1091'>				bitmask=<span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1092'>				<span class="pl-k">for</span>(i=<span class="pl-c1">0</span>;i&lt;TPD_KEY_COUNT;i++)</div><div class='line js-file-line' id='LC1093'>				{</div><div class='line js-file-line' id='LC1094'>					bitmask=<span class="pl-c1">1</span>&lt;&lt;i;</div><div class='line js-file-line' id='LC1095'>					<span class="pl-k">if</span>(reg_val[<span class="pl-c1">5</span>] &amp; bitmask) </div><div class='line js-file-line' id='LC1096'>					{ </div><div class='line js-file-line' id='LC1097'>						<span class="pl-c"><span class="pl-c">//</span>button[i] down</span></div><div class='line js-file-line' id='LC1098'>							<span class="pl-c"><span class="pl-c">//</span>printk(&quot;MYCAT Button%d down.\n&quot;,i);</span></div><div class='line js-file-line' id='LC1099'>							cinfo-&gt;x[<span class="pl-c1">0</span>]  = tpd_keys_dim_local[i][<span class="pl-c1">0</span>];</div><div class='line js-file-line' id='LC1100'>							cinfo-&gt;y[<span class="pl-c1">0</span>]=  tpd_keys_dim_local[i][<span class="pl-c1">1</span>];</div><div class='line js-file-line' id='LC1101'>							point_num = <span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC1102'>							<span class="pl-k">break</span>;</div><div class='line js-file-line' id='LC1103'>					}</div><div class='line js-file-line' id='LC1104'>					<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1105'>					{</div><div class='line js-file-line' id='LC1106'>						<span class="pl-k">if</span>(msg2133_priv.<span class="pl-smi">buttons</span> &amp; bitmask)</div><div class='line js-file-line' id='LC1107'>						{</div><div class='line js-file-line' id='LC1108'>							<span class="pl-c"><span class="pl-c">//</span>button[i] up</span></div><div class='line js-file-line' id='LC1109'>							<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>Button<span class="pl-c1">%d</span> up.<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>,i);</div><div class='line js-file-line' id='LC1110'>						}</div><div class='line js-file-line' id='LC1111'>					}</div><div class='line js-file-line' id='LC1112'>				}</div><div class='line js-file-line' id='LC1113'>			}</div><div class='line js-file-line' id='LC1114'>			<span class="pl-k">if</span>(i == TPD_KEY_COUNT)</div><div class='line js-file-line' id='LC1115'>			{</div><div class='line js-file-line' id='LC1116'>				point_num = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1117'>			}</div><div class='line js-file-line' id='LC1118'><br></div><div class='line js-file-line' id='LC1119'>			msg2133_priv.<span class="pl-smi">buttons</span> = reg_val[<span class="pl-c1">5</span>];</div><div class='line js-file-line' id='LC1120'><span class="pl-c"><span class="pl-c">//</span>/////////////////////////////////////////////////////////////////////////add by lan</span></div><div class='line js-file-line' id='LC1121'>#<span class="pl-k">ifdef</span> TPD_PROXIMITY</div><div class='line js-file-line' id='LC1122'><span class="pl-c1">TPD_PROXIMITY_DEBUG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>mycat tpd_touchinfo reg_val[5] = <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, reg_val[<span class="pl-c1">5</span>]);</div><div class='line js-file-line' id='LC1123'><br></div><div class='line js-file-line' id='LC1124'>				<span class="pl-k">if</span> (tpd_proximity_flag == <span class="pl-c1">1</span>)</div><div class='line js-file-line' id='LC1125'>				{</div><div class='line js-file-line' id='LC1126'>					<span class="pl-k">if</span>(reg_val[<span class="pl-c1">5</span>]==0x40||reg_val[<span class="pl-c1">5</span>]==0x80)</div><div class='line js-file-line' id='LC1127'>					{</div><div class='line js-file-line' id='LC1128'>						<span class="pl-k">if</span> (reg_val[<span class="pl-c1">5</span>]==0x40)<span class="pl-c"><span class="pl-c">//</span> leave</span></div><div class='line js-file-line' id='LC1129'>						{</div><div class='line js-file-line' id='LC1130'>							tpd_proximity_detect = <span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC1131'>						}</div><div class='line js-file-line' id='LC1132'>						<span class="pl-k">else</span> <span class="pl-k">if</span> (reg_val[<span class="pl-c1">5</span>]==0x80)<span class="pl-c"><span class="pl-c">//</span> close to</span></div><div class='line js-file-line' id='LC1133'>						{</div><div class='line js-file-line' id='LC1134'>							tpd_proximity_detect = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1135'>						}</div><div class='line js-file-line' id='LC1136'>						<span class="pl-c"><span class="pl-c">//</span>get raw data</span></div><div class='line js-file-line' id='LC1137'>						<span class="pl-c1">TPD_PROXIMITY_DEBUG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span> ps change<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1138'>						<span class="pl-c"><span class="pl-c">//</span>map and store data to hwm_sensor_data</span></div><div class='line js-file-line' id='LC1139'>						sensor_data.<span class="pl-smi">values</span>[<span class="pl-c1">0</span>] = <span class="pl-c1">tpd_get_ps_value</span>();</div><div class='line js-file-line' id='LC1140'>						sensor_data.<span class="pl-smi">value_divide</span> = <span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC1141'>						sensor_data.<span class="pl-smi">status</span> = SENSOR_STATUS_ACCURACY_MEDIUM;</div><div class='line js-file-line' id='LC1142'>						<span class="pl-c"><span class="pl-c">//</span>let up layer to know</span></div><div class='line js-file-line' id='LC1143'>						<span class="pl-k">if</span>((err = <span class="pl-c1">hwmsen_get_interrupt_data</span>(ID_PROXIMITY, &amp;sensor_data)))</div><div class='line js-file-line' id='LC1144'>						{</div><div class='line js-file-line' id='LC1145'>							<span class="pl-c1">TPD_PROXIMITY_DEBUG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>call hwmsen_get_interrupt_data fail = <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, err);</div><div class='line js-file-line' id='LC1146'>						}</div><div class='line js-file-line' id='LC1147'>						<span class="pl-k">return</span>  <span class="pl-c1">false</span>;</div><div class='line js-file-line' id='LC1148'>					}</div><div class='line js-file-line' id='LC1149'>					<span class="pl-k">else</span> <span class="pl-k">if</span>(reg_val[<span class="pl-c1">5</span>]==0xC0)</div><div class='line js-file-line' id='LC1150'>					{</div><div class='line js-file-line' id='LC1151'>						<span class="pl-c1">tpd_enable_ps</span>(<span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC1152'>						<span class="pl-k">return</span>  <span class="pl-c1">false</span>;</div><div class='line js-file-line' id='LC1153'>					}</div><div class='line js-file-line' id='LC1154'>				}</div><div class='line js-file-line' id='LC1155'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1156'><br></div><div class='line js-file-line' id='LC1157'><br></div><div class='line js-file-line' id='LC1158'><br></div><div class='line js-file-line' id='LC1159'><br></div><div class='line js-file-line' id='LC1160'>	     }</div><div class='line js-file-line' id='LC1161'>#<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1162'>	     <span class="pl-k">if</span>(reg_val[<span class="pl-c1">1</span>] == 0xFF &amp;&amp; reg_val[<span class="pl-c1">2</span>] == 0xFF&amp;&amp; reg_val[<span class="pl-c1">3</span>] == 0xFF&amp;&amp; reg_val[<span class="pl-c1">4</span>] == 0xFF&amp;&amp; reg_val[<span class="pl-c1">5</span>] == 0xFF &amp;&amp; reg_val[<span class="pl-c1">6</span>] == 0xFF)</div><div class='line js-file-line' id='LC1163'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1164'>		  	point_num = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1165'>	     }</div><div class='line js-file-line' id='LC1166'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1167'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">else</span> <span class="pl-k">if</span>((ShortTouchState.<span class="pl-smi">dst_x</span> == <span class="pl-c1">0</span>) &amp;&amp; (ShortTouchState.<span class="pl-smi">dst_y</span> == <span class="pl-c1">0</span>))</div><div class='line js-file-line' id='LC1168'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1169'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#<span class="pl-k">if</span> defined(TPD_XY_INVERT)</div><div class='line js-file-line' id='LC1170'><br></div><div class='line js-file-line' id='LC1171'>		  #<span class="pl-k">if</span> defined(TPD_X_INVERT)</div><div class='line js-file-line' id='LC1172'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;x[<span class="pl-c1">0</span>] = (<span class="pl-c1">2048</span>-ShortTouchState.<span class="pl-smi">pos_y</span>) * TPD_RES_X / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1173'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1174'>		  cinfo-&gt;x[<span class="pl-c1">0</span>] = (ShortTouchState.<span class="pl-smi">pos_y</span>) * TPD_RES_X / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1175'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1176'><br></div><div class='line js-file-line' id='LC1177'>		  #<span class="pl-k">if</span> defined(TPD_Y_INVERT)</div><div class='line js-file-line' id='LC1178'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;y[<span class="pl-c1">0</span>] = (<span class="pl-c1">2048</span>-ShortTouchState.<span class="pl-smi">pos_x</span>) * TPD_RES_Y / <span class="pl-c1">2048</span>;	</div><div class='line js-file-line' id='LC1179'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1180'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;y[<span class="pl-c1">0</span>] = ShortTouchState.<span class="pl-smi">pos_x</span> * TPD_RES_Y / <span class="pl-c1">2048</span>;	</div><div class='line js-file-line' id='LC1181'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1182'><br></div><div class='line js-file-line' id='LC1183'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1184'><br></div><div class='line js-file-line' id='LC1185'>		  #<span class="pl-k">if</span> defined(TPD_X_INVERT)</div><div class='line js-file-line' id='LC1186'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;x[<span class="pl-c1">0</span>] = (<span class="pl-c1">2048</span>-ShortTouchState.<span class="pl-smi">pos_x</span>) * TPD_RES_X / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1187'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1188'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;x[<span class="pl-c1">0</span>] = ShortTouchState.<span class="pl-smi">pos_x</span> * TPD_RES_X / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1189'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1190'><br></div><div class='line js-file-line' id='LC1191'>		  #<span class="pl-k">if</span> defined(TPD_Y_INVERT)</div><div class='line js-file-line' id='LC1192'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;y[<span class="pl-c1">0</span>] = (<span class="pl-c1">2048</span>-ShortTouchState.<span class="pl-smi">pos_y</span>) * TPD_RES_Y / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1193'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1194'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;y[<span class="pl-c1">0</span>] = ShortTouchState.<span class="pl-smi">pos_y</span> * TPD_RES_Y / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1195'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1196'><br></div><div class='line js-file-line' id='LC1197'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1198'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;point_num = <span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC1199'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1200'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1201'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1202'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#<span class="pl-k">if</span> defined(TPD_XY_INVERT)</div><div class='line js-file-line' id='LC1203'><br></div><div class='line js-file-line' id='LC1204'>		  #<span class="pl-k">if</span> defined(TPD_X_INVERT)</div><div class='line js-file-line' id='LC1205'>		   cinfo-&gt;x[<span class="pl-c1">0</span>] = (<span class="pl-c1">2048</span>-ShortTouchState.<span class="pl-smi">pos_y</span>) * TPD_RES_X / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1206'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1207'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;x[<span class="pl-c1">0</span>] = ShortTouchState.<span class="pl-smi">pos_y</span> * TPD_RES_X / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1208'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1209'><br></div><div class='line js-file-line' id='LC1210'>		  #<span class="pl-k">if</span> defined(TPD_Y_INVERT)</div><div class='line js-file-line' id='LC1211'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;y[<span class="pl-c1">0</span>] = (<span class="pl-c1">2048</span>-ShortTouchState.<span class="pl-smi">pos_x</span>) * TPD_RES_Y / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1212'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1213'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;y[<span class="pl-c1">0</span>] = ShortTouchState.<span class="pl-smi">pos_x</span> * TPD_RES_Y / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1214'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1215'><br></div><div class='line js-file-line' id='LC1216'>		  #<span class="pl-k">if</span> defined(TPD_X_INVERT)</div><div class='line js-file-line' id='LC1217'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;x[<span class="pl-c1">1</span>] = (<span class="pl-c1">2048</span>-ShortTouchState.<span class="pl-smi">pos_y2</span>) * TPD_RES_X / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1218'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1219'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;x[<span class="pl-c1">1</span>] = ShortTouchState.<span class="pl-smi">pos_y2</span> * TPD_RES_X / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1220'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1221'><br></div><div class='line js-file-line' id='LC1222'>		  #<span class="pl-k">if</span> defined(TPD_Y_INVERT)</div><div class='line js-file-line' id='LC1223'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;y[<span class="pl-c1">1</span>] = (<span class="pl-c1">2048</span>-ShortTouchState.<span class="pl-smi">pos_x2</span>) * TPD_RES_Y / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1224'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1225'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;y[<span class="pl-c1">1</span>] = ShortTouchState.<span class="pl-smi">pos_x2</span> * TPD_RES_Y / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1226'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1227'><br></div><div class='line js-file-line' id='LC1228'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1229'><br></div><div class='line js-file-line' id='LC1230'>		  #<span class="pl-k">if</span> defined(TPD_X_INVERT)</div><div class='line js-file-line' id='LC1231'>		  cinfo-&gt;x[<span class="pl-c1">0</span>] = (<span class="pl-c1">2048</span>-ShortTouchState.<span class="pl-smi">pos_x</span>) * TPD_RES_X / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1232'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1233'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;x[<span class="pl-c1">0</span>] = ShortTouchState.<span class="pl-smi">pos_x</span> * TPD_RES_X / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1234'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1235'><br></div><div class='line js-file-line' id='LC1236'>		  #<span class="pl-k">if</span> defined(TPD_Y_INVERT)</div><div class='line js-file-line' id='LC1237'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;y[<span class="pl-c1">0</span>] = (<span class="pl-c1">2048</span>-ShortTouchState.<span class="pl-smi">pos_y</span>) * TPD_RES_Y / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1238'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1239'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;y[<span class="pl-c1">0</span>] = ShortTouchState.<span class="pl-smi">pos_y</span> * TPD_RES_Y / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1240'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1241'><br></div><div class='line js-file-line' id='LC1242'>		  #<span class="pl-k">if</span> defined(TPD_X_INVERT)</div><div class='line js-file-line' id='LC1243'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;x[<span class="pl-c1">1</span>] = (<span class="pl-c1">2048</span>-ShortTouchState.<span class="pl-smi">pos_x2</span>) * TPD_RES_X / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1244'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1245'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;x[<span class="pl-c1">1</span>] = ShortTouchState.<span class="pl-smi">pos_x2</span> * TPD_RES_X / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1246'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1247'><br></div><div class='line js-file-line' id='LC1248'>		  #<span class="pl-k">if</span> defined(TPD_Y_INVERT)</div><div class='line js-file-line' id='LC1249'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;y[<span class="pl-c1">1</span>] = (<span class="pl-c1">2048</span>-ShortTouchState.<span class="pl-smi">pos_y2</span>) * TPD_RES_Y / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1250'>		  #<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1251'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cinfo-&gt;y[<span class="pl-c1">1</span>] = ShortTouchState.<span class="pl-smi">pos_y2</span> * TPD_RES_Y / <span class="pl-c1">2048</span>;</div><div class='line js-file-line' id='LC1252'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1253'><br></div><div class='line js-file-line' id='LC1254'>		  #<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1255'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;point_num = <span class="pl-c1">2</span>;</div><div class='line js-file-line' id='LC1256'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1257'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1258'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> <span class="pl-c1">true</span>;</div><div class='line js-file-line' id='LC1259'>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1260'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1261'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1262'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>tpd_check_sum_ XXXX<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1263'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span>  <span class="pl-c1">false</span>;</div><div class='line js-file-line' id='LC1264'>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1265'><br></div><div class='line js-file-line' id='LC1266'>}</div><div class='line js-file-line' id='LC1267'><br></div><div class='line js-file-line' id='LC1268'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">touch_event_handler</span>(<span class="pl-k">void</span> *unused)</div><div class='line js-file-line' id='LC1269'>{</div><div class='line js-file-line' id='LC1270'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">struct</span> touch_info cinfo;</div><div class='line js-file-line' id='LC1271'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">int</span> touch_state = <span class="pl-c1">3</span>;</div><div class='line js-file-line' id='LC1272'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">unsigned</span> <span class="pl-k">long</span> time_eclapse;</div><div class='line js-file-line' id='LC1273'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">struct</span> <span class="pl-c1">sched_param</span> param = { .<span class="pl-smi">sched_priority</span> = RTPM_PRIO_TPD };</div><div class='line js-file-line' id='LC1274'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">sched_setscheduler</span>(current, SCHED_RR, &amp;param);</div><div class='line js-file-line' id='LC1275'><br></div><div class='line js-file-line' id='LC1276'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">do</span></div><div class='line js-file-line' id='LC1277'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1278'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt65xx_eint_unmask</span>(CUST_EINT_TOUCH_PANEL_NUM);</div><div class='line js-file-line' id='LC1279'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">set_current_state</span>(TASK_INTERRUPTIBLE);</div><div class='line js-file-line' id='LC1280'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">wait_event_interruptible</span>(waiter, tpd_flag != <span class="pl-c1">0</span>);</div><div class='line js-file-line' id='LC1281'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tpd_flag = <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1282'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">set_current_state</span>(TASK_RUNNING);</div><div class='line js-file-line' id='LC1283'><br></div><div class='line js-file-line' id='LC1284'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(<span class="pl-c1">tpd_touchinfo</span>(&amp;cinfo))</div><div class='line js-file-line' id='LC1285'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1286'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c"><span class="pl-c">//</span>printk(&quot;MYCAT MSG_X = %d,MSG_Y = %d\n&quot;, cinfo.x[0], cinfo.y[0]);</span></div><div class='line js-file-line' id='LC1287'><br></div><div class='line js-file-line' id='LC1288'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(point_num == <span class="pl-c1">1</span>)</div><div class='line js-file-line' id='LC1289'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1290'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">tpd_down</span>(cinfo.<span class="pl-smi">x</span>[<span class="pl-c1">0</span>], cinfo.<span class="pl-smi">y</span>[<span class="pl-c1">0</span>]);</div><div class='line js-file-line' id='LC1291'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>msg_press 1 point---&gt;<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1292'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">input_sync</span>(tpd-&gt;dev);</div><div class='line js-file-line' id='LC1293'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1294'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">else</span> <span class="pl-k">if</span>(point_num == <span class="pl-c1">2</span>)</div><div class='line js-file-line' id='LC1295'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1296'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c"><span class="pl-c">//</span>printk(&quot;MYCAT MSG_X2 = %d,MSG_Y2 = %d\n&quot;, cinfo.x[1], cinfo.y[1]);</span></div><div class='line js-file-line' id='LC1297'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">tpd_down</span>(cinfo.<span class="pl-smi">x</span>[<span class="pl-c1">0</span>], cinfo.<span class="pl-smi">y</span>[<span class="pl-c1">0</span>]);</div><div class='line js-file-line' id='LC1298'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">tpd_down</span>(cinfo.<span class="pl-smi">x</span>[<span class="pl-c1">1</span>], cinfo.<span class="pl-smi">y</span>[<span class="pl-c1">1</span>]);</div><div class='line js-file-line' id='LC1299'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>msg_press 2 points---&gt;<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1300'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">input_sync</span>(tpd-&gt;dev);</div><div class='line js-file-line' id='LC1301'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1302'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">else</span> <span class="pl-k">if</span>(point_num == <span class="pl-c1">0</span>)</div><div class='line js-file-line' id='LC1303'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1304'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	<span class="pl-c"><span class="pl-c">//</span>huangrunming</span></div><div class='line js-file-line' id='LC1305'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	<span class="pl-k">if</span> (FACTORY_BOOT == <span class="pl-c1">get_boot_mode</span>()|| RECOVERY_BOOT == <span class="pl-c1">get_boot_mode</span>())</div><div class='line js-file-line' id='LC1306'>		{</div><div class='line js-file-line' id='LC1307'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>release ---&gt;<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1308'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">tpd_up</span>(cinfo.<span class="pl-smi">x</span>[<span class="pl-c1">0</span>], cinfo.<span class="pl-smi">y</span>[<span class="pl-c1">0</span>]);</div><div class='line js-file-line' id='LC1309'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c"><span class="pl-c">//</span>input_mt_sync(tpd-&gt;dev);</span></div><div class='line js-file-line' id='LC1310'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">input_sync</span>(tpd-&gt;dev);</div><div class='line js-file-line' id='LC1311'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<span class="pl-k">else</span>{</div><div class='line js-file-line' id='LC1312'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>release ---&gt;<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1313'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">input_mt_sync</span>(tpd-&gt;dev);</div><div class='line js-file-line' id='LC1314'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">input_sync</span>(tpd-&gt;dev);                </div><div class='line js-file-line' id='LC1315'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1316'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1317'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1318'>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1319'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">while</span>(!<span class="pl-c1">kthread_should_stop</span>());</div><div class='line js-file-line' id='LC1320'><br></div><div class='line js-file-line' id='LC1321'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1322'>}</div><div class='line js-file-line' id='LC1323'><br></div><div class='line js-file-line' id='LC1324'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">tpd_detect</span>(<span class="pl-k">struct</span> i2c_client *client , <span class="pl-k">struct</span> i2c_board_info *info)</div><div class='line js-file-line' id='LC1325'>{</div><div class='line js-file-line' id='LC1326'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">strcpy</span>(info-&gt;type, <span class="pl-s"><span class="pl-pds">&quot;</span>msg2133<span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1327'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1328'>}</div><div class='line js-file-line' id='LC1329'><br></div><div class='line js-file-line' id='LC1330'><span class="pl-k">static</span> <span class="pl-k">void</span> <span class="pl-en">tpd_eint_interrupt_handler</span>(<span class="pl-k">void</span>)</div><div class='line js-file-line' id='LC1331'>{</div><div class='line js-file-line' id='LC1332'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c"><span class="pl-c">//</span>printk(&quot;MYCAT MSG2133 TPD interrupt has been triggered\n&quot;);</span></div><div class='line js-file-line' id='LC1333'>&nbsp;&nbsp;&nbsp;&nbsp;tpd_flag = <span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC1334'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">wake_up_interruptible</span>(&amp;waiter);</div><div class='line js-file-line' id='LC1335'>}</div><div class='line js-file-line' id='LC1336'><br></div><div class='line js-file-line' id='LC1337'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">tpd_probe</span>(<span class="pl-k">struct</span> i2c_client *client, <span class="pl-k">const</span> <span class="pl-k">struct</span> i2c_device_id *id)</div><div class='line js-file-line' id='LC1338'>{</div><div class='line js-file-line' id='LC1339'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">int</span> retval = TPD_OK;</div><div class='line js-file-line' id='LC1340'>	BYTE reg_testval[<span class="pl-c1">8</span>] = {<span class="pl-c1">0</span>};</div><div class='line js-file-line' id='LC1341'><br></div><div class='line js-file-line' id='LC1342'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span> func: <span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, __func__);</div><div class='line js-file-line' id='LC1343'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">char</span> data;</div><div class='line js-file-line' id='LC1344'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client-&gt;timing = <span class="pl-c1">200</span>;</div><div class='line js-file-line' id='LC1345'>&nbsp;&nbsp;&nbsp;&nbsp;client-&gt;addr |= I2C_ENEXT_FLAG;</div><div class='line js-file-line' id='LC1346'>&nbsp;&nbsp;&nbsp;&nbsp;i2c_client = client;</div><div class='line js-file-line' id='LC1347'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>MYCAT In tpd_probe_ ,the i2c addr=0x<span class="pl-c1">%x</span><span class="pl-pds">&quot;</span></span>, client-&gt;addr);</div><div class='line js-file-line' id='LC1348'><br></div><div class='line js-file-line' id='LC1349'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(TPD_POWER_SOURCE != MT65XX_POWER_NONE)</div><div class='line js-file-line' id='LC1350'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1351'>	    <span class="pl-c1">hwPowerDown</span>(TPD_POWER_SOURCE,<span class="pl-s"><span class="pl-pds">&quot;</span>TP<span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1352'>	    <span class="pl-c1">hwPowerOn</span>(TPD_POWER_SOURCE,VOL_2800,<span class="pl-s"><span class="pl-pds">&quot;</span>TP<span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1353'>	    <span class="pl-c1">msleep</span>(<span class="pl-c1">100</span>);	</div><div class='line js-file-line' id='LC1354'>&nbsp;&nbsp;&nbsp;&nbsp;}	</div><div class='line js-file-line' id='LC1355'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_mode</span>(GPIO_CTP_RST_PIN, <span class="pl-c1">0</span>);		<span class="pl-c"><span class="pl-c">//</span>GPIO_CTP_RST_PIN</span></div><div class='line js-file-line' id='LC1356'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_dir</span>(GPIO_CTP_RST_PIN, GPIO_DIR_OUT);		</div><div class='line js-file-line' id='LC1357'>	<span class="pl-c1">mt_set_gpio_pull_enable</span>(GPIO_CTP_RST_PIN, GPIO_PULL_ENABLE);</div><div class='line js-file-line' id='LC1358'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_pull_select</span>(GPIO_CTP_RST_PIN, GPIO_PULL_UP);</div><div class='line js-file-line' id='LC1359'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_out</span>(GPIO_CTP_RST_PIN, GPIO_OUT_ZERO);</div><div class='line js-file-line' id='LC1360'>&nbsp;&nbsp;&nbsp;</div><div class='line js-file-line' id='LC1361'>	<span class="pl-c1">msleep</span>(<span class="pl-c1">100</span>);</div><div class='line js-file-line' id='LC1362'>	<span class="pl-c1">mt_set_gpio_out</span>(GPIO_CTP_RST_PIN, GPIO_OUT_ONE);</div><div class='line js-file-line' id='LC1363'><br></div><div class='line js-file-line' id='LC1364'><br></div><div class='line js-file-line' id='LC1365'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_mode</span>(GPIO_CTP_EINT_PIN, GPIO_CTP_EINT_PIN_M_EINT);</div><div class='line js-file-line' id='LC1366'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_dir</span>(GPIO_CTP_EINT_PIN, GPIO_DIR_IN);</div><div class='line js-file-line' id='LC1367'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_pull_enable</span>(GPIO_CTP_EINT_PIN, GPIO_PULL_ENABLE);</div><div class='line js-file-line' id='LC1368'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_pull_select</span>(GPIO_CTP_EINT_PIN, GPIO_PULL_UP);</div><div class='line js-file-line' id='LC1369'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt65xx_eint_set_sens</span>(CUST_EINT_TOUCH_PANEL_NUM, CUST_EINT_TOUCH_PANEL_SENSITIVE);</div><div class='line js-file-line' id='LC1370'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt65xx_eint_set_hw_debounce</span>(CUST_EINT_TOUCH_PANEL_NUM, CUST_EINT_TOUCH_PANEL_DEBOUNCE_CN);</div><div class='line js-file-line' id='LC1371'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt65xx_eint_registration</span>(CUST_EINT_TOUCH_PANEL_NUM, CUST_EINT_TOUCH_PANEL_DEBOUNCE_EN, CUST_EINT_TOUCH_PANEL_POLARITY, tpd_eint_interrupt_handler, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC1372'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt65xx_eint_unmask</span>(CUST_EINT_TOUCH_PANEL_NUM);</div><div class='line js-file-line' id='LC1373'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">msleep</span>(<span class="pl-c1">100</span>);</div><div class='line js-file-line' id='LC1374'><br></div><div class='line js-file-line' id='LC1375'>&nbsp;&nbsp;&nbsp;&nbsp;tpd_load_status = <span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC1376'>&nbsp;&nbsp;&nbsp;&nbsp;thread = <span class="pl-c1">kthread_run</span>(touch_event_handler, <span class="pl-c1">0</span>, TPD_DEVICE);</div><div class='line js-file-line' id='LC1377'><br></div><div class='line js-file-line' id='LC1378'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(<span class="pl-c1">IS_ERR</span>(thread))</div><div class='line js-file-line' id='LC1379'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1380'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retval = <span class="pl-c1">PTR_ERR</span>(thread);</div><div class='line js-file-line' id='LC1381'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(TPD_DEVICE <span class="pl-s"><span class="pl-pds">&quot;</span> failed to create kernel thread: <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, retval);</div><div class='line js-file-line' id='LC1382'>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1383'><br></div><div class='line js-file-line' id='LC1384'>&nbsp;&nbsp;&nbsp;&nbsp;</div><div class='line js-file-line' id='LC1385'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span> (<span class="pl-c1">TRUE</span>==<span class="pl-c1">msg2033_i2c_read</span>(data,<span class="pl-c1">1</span>))</div><div class='line js-file-line' id='LC1386'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1387'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c"><span class="pl-c">//</span>SSL_PRINT(&quot;Mstar &#39;s TP\n&quot;);</span></div><div class='line js-file-line' id='LC1388'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c"><span class="pl-c">//</span>SMC_SWITCH=1;</span></div><div class='line js-file-line' id='LC1389'>			 <span class="pl-k">return</span> -<span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC1390'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1391'>&nbsp;&nbsp;&nbsp;&nbsp;</div><div class='line js-file-line' id='LC1392'><span class="pl-c"><span class="pl-c">/*</span></span></div><div class='line js-file-line' id='LC1393'><span class="pl-c">		firmware_class = class_create(THIS_MODULE, &quot;ms-touchscreen-msg20xx&quot;);</span></div><div class='line js-file-line' id='LC1394'><span class="pl-c">	</span></div><div class='line js-file-line' id='LC1395'><span class="pl-c">		if(IS_ERR(firmware_class))</span></div><div class='line js-file-line' id='LC1396'><span class="pl-c">		{</span></div><div class='line js-file-line' id='LC1397'><span class="pl-c">			pr_err(&quot;Failed to create class(firmware)!\n&quot;);</span></div><div class='line js-file-line' id='LC1398'><span class="pl-c">		}</span></div><div class='line js-file-line' id='LC1399'><span class="pl-c">	</span></div><div class='line js-file-line' id='LC1400'><span class="pl-c">		firmware_cmd_dev = device_create(firmware_class,NULL, 0, NULL, &quot;device&quot;);</span></div><div class='line js-file-line' id='LC1401'><span class="pl-c">	</span></div><div class='line js-file-line' id='LC1402'><span class="pl-c">		if(IS_ERR(firmware_cmd_dev))</span></div><div class='line js-file-line' id='LC1403'><span class="pl-c">		{</span></div><div class='line js-file-line' id='LC1404'><span class="pl-c">			pr_err(&quot;Failed to create device(firmware_cmd_dev)!\n&quot;);</span></div><div class='line js-file-line' id='LC1405'><span class="pl-c">		}</span></div><div class='line js-file-line' id='LC1406'><span class="pl-c">	</span></div><div class='line js-file-line' id='LC1407'><span class="pl-c">		// version</span></div><div class='line js-file-line' id='LC1408'><span class="pl-c">		if(device_create_file(firmware_cmd_dev, &amp;dev_attr_version) &lt; 0)</span></div><div class='line js-file-line' id='LC1409'><span class="pl-c">		{</span></div><div class='line js-file-line' id='LC1410'><span class="pl-c">			pr_err(&quot;Failed to create device file(%s)!\n&quot;, dev_attr_version.attr.name);</span></div><div class='line js-file-line' id='LC1411'><span class="pl-c">		}</span></div><div class='line js-file-line' id='LC1412'><span class="pl-c">	</span></div><div class='line js-file-line' id='LC1413'><span class="pl-c">		// update</span></div><div class='line js-file-line' id='LC1414'><span class="pl-c">		if(device_create_file(firmware_cmd_dev, &amp;dev_attr_update) &lt; 0)</span></div><div class='line js-file-line' id='LC1415'><span class="pl-c">		{</span></div><div class='line js-file-line' id='LC1416'><span class="pl-c">			pr_err(&quot;Failed to create device file(%s)!\n&quot;, dev_attr_update.attr.name);</span></div><div class='line js-file-line' id='LC1417'><span class="pl-c">		}</span></div><div class='line js-file-line' id='LC1418'><span class="pl-c">	</span></div><div class='line js-file-line' id='LC1419'><span class="pl-c">		// data</span></div><div class='line js-file-line' id='LC1420'><span class="pl-c">		if(device_create_file(firmware_cmd_dev, &amp;dev_attr_data) &lt; 0)</span></div><div class='line js-file-line' id='LC1421'><span class="pl-c">		{</span></div><div class='line js-file-line' id='LC1422'><span class="pl-c">			pr_err(&quot;Failed to create device file(%s)!\n&quot;, dev_attr_data.attr.name);</span></div><div class='line js-file-line' id='LC1423'><span class="pl-c">		}</span></div><div class='line js-file-line' id='LC1424'><span class="pl-c">	</span></div><div class='line js-file-line' id='LC1425'><span class="pl-c">		dev_set_drvdata(firmware_cmd_dev, NULL);</span></div><div class='line js-file-line' id='LC1426'><span class="pl-c">#endif</span></div><div class='line js-file-line' id='LC1427'><span class="pl-c">//////////////////////////////////////////////////////////////////////add by lan</span></div><div class='line js-file-line' id='LC1428'><span class="pl-c">#ifdef TPD_PROXIMITY</span></div><div class='line js-file-line' id='LC1429'><span class="pl-c"></span></div><div class='line js-file-line' id='LC1430'><span class="pl-c">	if(device_create_file(firmware_cmd_dev, &amp;dev_attr_proximity_sensor) &lt; 0) // /sys/class/mtk-tpd/device/proximity_sensor</span></div><div class='line js-file-line' id='LC1431'><span class="pl-c">		{</span></div><div class='line js-file-line' id='LC1432'><span class="pl-c"> 			printk(&quot;xxxxx mycat Failed to create device file(%s)!\n&quot;, dev_attr_proximity_sensor.attr.name);</span></div><div class='line js-file-line' id='LC1433'><span class="pl-c">		}</span></div><div class='line js-file-line' id='LC1434'><span class="pl-c">#endif</span></div><div class='line js-file-line' id='LC1435'><span class="pl-c"><span class="pl-c">*/</span></span></div><div class='line js-file-line' id='LC1436'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>MYCAT Touch Panel Device Probe <span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, (retval &lt; TPD_OK) ? <span class="pl-s"><span class="pl-pds">&quot;</span>FAIL<span class="pl-pds">&quot;</span></span> : <span class="pl-s"><span class="pl-pds">&quot;</span>PASS<span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1437'><br></div><div class='line js-file-line' id='LC1438'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1439'>}</div><div class='line js-file-line' id='LC1440'><br></div><div class='line js-file-line' id='LC1441'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">tpd_remove</span>(<span class="pl-k">struct</span> i2c_client *client)</div><div class='line js-file-line' id='LC1442'><br></div><div class='line js-file-line' id='LC1443'>{</div><div class='line js-file-line' id='LC1444'><span class="pl-c"><span class="pl-c">//</span>///////////////////////////////////////////////////////////////////////add by lan</span></div><div class='line js-file-line' id='LC1445'>#<span class="pl-k">ifdef</span> TPD_PROXIMITY	</div><div class='line js-file-line' id='LC1446'>	<span class="pl-k">if</span> (tpd_proximity_flag == <span class="pl-c1">1</span>)</div><div class='line js-file-line' id='LC1447'>	{</div><div class='line js-file-line' id='LC1448'>		<span class="pl-k">if</span>(tpd_proximity_flag_one == <span class="pl-c1">1</span>)</div><div class='line js-file-line' id='LC1449'>		{</div><div class='line js-file-line' id='LC1450'>			tpd_proximity_flag_one = <span class="pl-c1">0</span>;	</div><div class='line js-file-line' id='LC1451'>			<span class="pl-c1">TPD_DMESG</span>(TPD_DEVICE <span class="pl-s"><span class="pl-pds">&quot;</span> tpd_proximity_flag_one <span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>); </div><div class='line js-file-line' id='LC1452'>			<span class="pl-k">return</span>;</div><div class='line js-file-line' id='LC1453'>		}</div><div class='line js-file-line' id='LC1454'>	}</div><div class='line js-file-line' id='LC1455'>#<span class="pl-k">endif</span>	</div><div class='line js-file-line' id='LC1456'>#<span class="pl-k">ifdef</span> TPD_PROXIMITY	</div><div class='line js-file-line' id='LC1457'>	<span class="pl-c1">TPD_PROXIMITY_DEBUG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>xxxxx mycat tpd_proximity_flag = <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, tpd_proximity_flag);</div><div class='line js-file-line' id='LC1458'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1459'><br></div><div class='line js-file-line' id='LC1460'><br></div><div class='line js-file-line' id='LC1461'><br></div><div class='line js-file-line' id='LC1462'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span> func: <span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, __func__);</div><div class='line js-file-line' id='LC1463'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1464'>}</div><div class='line js-file-line' id='LC1465'><br></div><div class='line js-file-line' id='LC1466'><br></div><div class='line js-file-line' id='LC1467'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">tpd_local_init</span>(<span class="pl-k">void</span>)</div><div class='line js-file-line' id='LC1468'>{</div><div class='line js-file-line' id='LC1469'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span> func: <span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, __func__);</div><div class='line js-file-line' id='LC1470'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span> MSG2133 I2C Touchscreen Driver (Built <span class="pl-c1">%s</span> @ <span class="pl-c1">%s</span>)<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, __DATE__, __TIME__);</div><div class='line js-file-line' id='LC1471'><br></div><div class='line js-file-line' id='LC1472'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(<span class="pl-c1">i2c_add_driver</span>(&amp;tpd_i2c_driver) != <span class="pl-c1">0</span>)</div><div class='line js-file-line' id='LC1473'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1474'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>unable to add i2c driver.<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1475'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> -<span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC1476'>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1477'><br></div><div class='line js-file-line' id='LC1478'>#<span class="pl-k">ifdef</span> TPD_HAVE_BUTTON</div><div class='line js-file-line' id='LC1479'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">tpd_button_setting</span>(TPD_KEY_COUNT, tpd_keys_local, tpd_keys_dim_local);<span class="pl-c"><span class="pl-c">//</span> initialize tpd button data</span></div><div class='line js-file-line' id='LC1480'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1481'>#<span class="pl-k">if</span> (defined(TPD_WARP_START) &amp;&amp; defined(TPD_WARP_END))</div><div class='line js-file-line' id='LC1482'>&nbsp;&nbsp;&nbsp;&nbsp;TPD_DO_WARP = <span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC1483'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">memcpy</span>(tpd_wb_start, tpd_wb_start_local, TPD_WARP_CNT * <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC1484'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">memcpy</span>(tpd_wb_end, tpd_wb_start_local, TPD_WARP_CNT * <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC1485'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1486'>#<span class="pl-k">if</span> (defined(TPD_HAVE_CALIBRATION) &amp;&amp; !defined(TPD_CUSTOM_CALIBRATION))</div><div class='line js-file-line' id='LC1487'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">memcpy</span>(tpd_calmat, tpd_def_calmat_local, <span class="pl-c1">8</span> * <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC1488'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">memcpy</span>(tpd_def_calmat, tpd_def_calmat_local, <span class="pl-c1">8</span> * <span class="pl-c1">4</span>);</div><div class='line js-file-line' id='LC1489'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1490'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>end <span class="pl-c1">%s</span>, <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, __FUNCTION__, __LINE__);</div><div class='line js-file-line' id='LC1491'>&nbsp;&nbsp;&nbsp;&nbsp;tpd_type_cap = <span class="pl-c1">1</span>;</div><div class='line js-file-line' id='LC1492'>&nbsp;&nbsp;&nbsp;&nbsp;msg2133_priv.<span class="pl-smi">buttons</span>=<span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1493'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1494'>}</div><div class='line js-file-line' id='LC1495'><br></div><div class='line js-file-line' id='LC1496'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">tpd_resume</span>(<span class="pl-k">struct</span> i2c_client *client)</div><div class='line js-file-line' id='LC1497'>{</div><div class='line js-file-line' id='LC1498'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">int</span> retval = TPD_OK;</div><div class='line js-file-line' id='LC1499'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span> func: <span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, __func__);</div><div class='line js-file-line' id='LC1500'><br></div><div class='line js-file-line' id='LC1501'>#<span class="pl-k">ifdef</span> TP_FIRMWARE_UPDATE</div><div class='line js-file-line' id='LC1502'>	<span class="pl-k">if</span>(update_switch==<span class="pl-c1">1</span>)</div><div class='line js-file-line' id='LC1503'>	{</div><div class='line js-file-line' id='LC1504'>		<span class="pl-k">return</span> <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1505'>	}</div><div class='line js-file-line' id='LC1506'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1507'><br></div><div class='line js-file-line' id='LC1508'><br></div><div class='line js-file-line' id='LC1509'>#<span class="pl-k">ifdef</span> TPD_CLOSE_POWER_IN_SLEEP</div><div class='line js-file-line' id='LC1510'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">hwPowerOn</span>(TPD_POWER_SOURCE, VOL_3300, <span class="pl-s"><span class="pl-pds">&quot;</span>TP<span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1511'>#<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1512'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_mode</span>(GPIO_CTP_RST_PIN, GPIO_CTP_RST_PIN_M_GPIO);</div><div class='line js-file-line' id='LC1513'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_dir</span>(GPIO_CTP_RST_PIN, GPIO_DIR_OUT);</div><div class='line js-file-line' id='LC1514'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_out</span>(GPIO_CTP_RST_PIN, GPIO_OUT_ONE);</div><div class='line js-file-line' id='LC1515'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1516'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">msleep</span>(<span class="pl-c1">200</span>);</div><div class='line js-file-line' id='LC1517'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt65xx_eint_unmask</span>(CUST_EINT_TOUCH_PANEL_NUM);</div><div class='line js-file-line' id='LC1518'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> retval;</div><div class='line js-file-line' id='LC1519'>}</div><div class='line js-file-line' id='LC1520'><br></div><div class='line js-file-line' id='LC1521'><span class="pl-k">static</span> <span class="pl-k">int</span> <span class="pl-en">tpd_suspend</span>(<span class="pl-k">struct</span> i2c_client *client, <span class="pl-c1">pm_message_t</span> message)</div><div class='line js-file-line' id='LC1522'>{</div><div class='line js-file-line' id='LC1523'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">int</span> retval = TPD_OK;</div><div class='line js-file-line' id='LC1524'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">static</span> <span class="pl-k">char</span> data = 0x3;</div><div class='line js-file-line' id='LC1525'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>TPD enter sleep<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1526'><span class="pl-c"><span class="pl-c">//</span>///////////////////////////////////////////////////////////////add by lan</span></div><div class='line js-file-line' id='LC1527'>#<span class="pl-k">ifdef</span> TPD_PROXIMITY</div><div class='line js-file-line' id='LC1528'>	<span class="pl-k">if</span> (tpd_proximity_flag == <span class="pl-c1">1</span>)</div><div class='line js-file-line' id='LC1529'>	{</div><div class='line js-file-line' id='LC1530'>		tpd_proximity_flag_one = <span class="pl-c1">1</span>;	</div><div class='line js-file-line' id='LC1531'>		<span class="pl-k">return</span>;</div><div class='line js-file-line' id='LC1532'>	}</div><div class='line js-file-line' id='LC1533'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1534'>#<span class="pl-k">ifdef</span> TPD_PROXIMITY	 </div><div class='line js-file-line' id='LC1535'>	<span class="pl-c1">TPD_PROXIMITY_DEBUG</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>xxxxx mycat tpd_proximity_flag = <span class="pl-c1">%d</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, tpd_proximity_flag);</div><div class='line js-file-line' id='LC1536'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1537'><br></div><div class='line js-file-line' id='LC1538'><br></div><div class='line js-file-line' id='LC1539'>#<span class="pl-k">ifdef</span> TP_FIRMWARE_UPDATE</div><div class='line js-file-line' id='LC1540'>		<span class="pl-k">if</span>(update_switch==<span class="pl-c1">1</span>)</div><div class='line js-file-line' id='LC1541'>		{</div><div class='line js-file-line' id='LC1542'>			<span class="pl-k">return</span> <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1543'>		}</div><div class='line js-file-line' id='LC1544'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1545'><br></div><div class='line js-file-line' id='LC1546'><br></div><div class='line js-file-line' id='LC1547'>#<span class="pl-k">ifdef</span> TP_PROXIMITY_SENSOR</div><div class='line js-file-line' id='LC1548'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span> (tp_proximity_state == ENABLE_CTP_PS){</div><div class='line js-file-line' id='LC1549'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c"><span class="pl-c">//</span> resume ......</span></div><div class='line js-file-line' id='LC1550'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> retval;</div><div class='line js-file-line' id='LC1551'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1552'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1553'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt65xx_eint_mask</span>(CUST_EINT_TOUCH_PANEL_NUM);</div><div class='line js-file-line' id='LC1554'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_mode</span>(GPIO_CTP_RST_PIN, GPIO_CTP_RST_PIN_M_GPIO);</div><div class='line js-file-line' id='LC1555'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_dir</span>(GPIO_CTP_RST_PIN, GPIO_DIR_OUT);</div><div class='line js-file-line' id='LC1556'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">mt_set_gpio_out</span>(GPIO_CTP_RST_PIN, GPIO_OUT_ZERO);</div><div class='line js-file-line' id='LC1557'>&nbsp;&nbsp;&nbsp;&nbsp;</div><div class='line js-file-line' id='LC1558'>#<span class="pl-k">ifdef</span> TPD_CLOSE_POWER_IN_SLEEP</div><div class='line js-file-line' id='LC1559'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">hwPowerDown</span>(TPD_POWER_SOURCE, <span class="pl-s"><span class="pl-pds">&quot;</span>TP<span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1560'>#<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1561'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c"><span class="pl-c">//</span>i2c_smbus_write_i2c_block_data(i2c_client, 0xA5, 1, &amp;data);  //TP enter sleep mode</span></div><div class='line js-file-line' id='LC1562'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c"><span class="pl-c">//</span>mt_set_gpio_mode(GPIO_CTP_RST_PIN, GPIO_CTP_RST_PIN_M_GPIO);</span></div><div class='line js-file-line' id='LC1563'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c"><span class="pl-c">//</span>mt_set_gpio_dir(GPIO_CTP_RST_PIN, GPIO_DIR_OUT);</span></div><div class='line js-file-line' id='LC1564'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c"><span class="pl-c">//</span>mt_set_gpio_out(GPIO_CTP_RST_PIN, GPIO_OUT_ZERO);</span></div><div class='line js-file-line' id='LC1565'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1566'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> retval;</div><div class='line js-file-line' id='LC1567'>}</div><div class='line js-file-line' id='LC1568'><br></div><div class='line js-file-line' id='LC1569'><br></div><div class='line js-file-line' id='LC1570'><span class="pl-k">static</span> <span class="pl-k">struct</span> <span class="pl-c1">tpd_driver_t</span> tpd_device_driver =</div><div class='line js-file-line' id='LC1571'>{</div><div class='line js-file-line' id='LC1572'>&nbsp;&nbsp;&nbsp;&nbsp;.<span class="pl-smi">tpd_device_name</span> = <span class="pl-s"><span class="pl-pds">&quot;</span>MSG2133<span class="pl-pds">&quot;</span></span>,</div><div class='line js-file-line' id='LC1573'>&nbsp;&nbsp;&nbsp;&nbsp;.<span class="pl-smi">tpd_local_init</span> = tpd_local_init,</div><div class='line js-file-line' id='LC1574'>&nbsp;&nbsp;&nbsp;&nbsp;.<span class="pl-smi">suspend</span> = tpd_suspend,</div><div class='line js-file-line' id='LC1575'>&nbsp;&nbsp;&nbsp;&nbsp;.<span class="pl-smi">resume</span> = tpd_resume,</div><div class='line js-file-line' id='LC1576'>#<span class="pl-k">ifdef</span> TPD_HAVE_BUTTON</div><div class='line js-file-line' id='LC1577'>&nbsp;&nbsp;&nbsp;&nbsp;.<span class="pl-smi">tpd_have_button</span> = <span class="pl-c1">1</span>,</div><div class='line js-file-line' id='LC1578'>#<span class="pl-k">else</span></div><div class='line js-file-line' id='LC1579'>&nbsp;&nbsp;&nbsp;&nbsp;.<span class="pl-smi">tpd_have_button</span> = <span class="pl-c1">0</span>,</div><div class='line js-file-line' id='LC1580'>#<span class="pl-k">endif</span></div><div class='line js-file-line' id='LC1581'>};</div><div class='line js-file-line' id='LC1582'><span class="pl-c"><span class="pl-c">/*</span> called when loaded into kernel <span class="pl-c">*/</span></span></div><div class='line js-file-line' id='LC1583'><span class="pl-k">static</span> <span class="pl-k">int</span> __init <span class="pl-en">tpd_driver_init</span>(<span class="pl-k">void</span>)</div><div class='line js-file-line' id='LC1584'>{</div><div class='line js-file-line' id='LC1585'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span> func: <span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, __func__);</div><div class='line js-file-line' id='LC1586'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">i2c_register_board_info</span>(<span class="pl-c1">1</span>, &amp;i2c_tpd, <span class="pl-c1">1</span>);</div><div class='line js-file-line' id='LC1587'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">if</span>(<span class="pl-c1">tpd_driver_add</span>(&amp;tpd_device_driver) &lt; <span class="pl-c1">0</span>)</div><div class='line js-file-line' id='LC1588'>&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class='line js-file-line' id='LC1589'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">printk</span>(<span class="pl-s"><span class="pl-pds">&quot;</span>add MSG2133 driver failed<span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>);</div><div class='line js-file-line' id='LC1590'>&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class='line js-file-line' id='LC1591'><br></div><div class='line js-file-line' id='LC1592'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-k">return</span> <span class="pl-c1">0</span>;</div><div class='line js-file-line' id='LC1593'>}</div><div class='line js-file-line' id='LC1594'><br></div><div class='line js-file-line' id='LC1595'><span class="pl-c"><span class="pl-c">/*</span> should never be called <span class="pl-c">*/</span></span></div><div class='line js-file-line' id='LC1596'><span class="pl-k">static</span> <span class="pl-k">void</span> __exit <span class="pl-en">tpd_driver_exit</span>(<span class="pl-k">void</span>)</div><div class='line js-file-line' id='LC1597'>{</div><div class='line js-file-line' id='LC1598'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">SSL_PRINT</span>(<span class="pl-s"><span class="pl-pds">&quot;</span> func: <span class="pl-c1">%s</span><span class="pl-cce">\n</span><span class="pl-pds">&quot;</span></span>, __func__);</div><div class='line js-file-line' id='LC1599'>&nbsp;&nbsp;&nbsp;&nbsp;<span class="pl-c1">tpd_driver_remove</span>(&amp;tpd_device_driver);</div><div class='line js-file-line' id='LC1600'>}</div><div class='line js-file-line' id='LC1601'><br></div><div class='line js-file-line' id='LC1602'><span class="pl-en">module_init</span>(tpd_driver_init);</div><div class='line js-file-line' id='LC1603'><span class="pl-en">module_exit</span>(tpd_driver_exit);</div><div class='line js-file-line' id='LC1604'><br></div><div class='line js-file-line' id='LC1605'><br></div></pre></div></div>
  </div>


  <footer class="clearfix">
    <div class="container">
      <a href="#"><svg aria-hidden="true" class="octicon octicon-mark-github" height="32" version="1.1" viewBox="0 0 16 16" width="32"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></a>

      <ul class="clearfix">
        <li>
          <!-- '"` --><!-- </textarea></xmp> --></option></form><form accept-charset="UTF-8" action="/site/mobile_preference" class="js-mobile-preference-form" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /><input name="authenticity_token" type="hidden" value="w4AQu/mTHBXmIxpin2uxMQ+QQmOmkHEJFQtwEM2AsJsrgyhP/fqQQSi5Cma3Tg6ka+nkKplQnceMuYYjTtgoZw==" /></div>
            <input type="hidden" name="mobile" value="false">
            <input type="hidden" name="anchor" class="js-mobile-preference-anchor-field">

            <button type="submit" class="switch-to-desktop" data-ga-click="Mobile, switch to desktop, switch button">
              Desktop version
            </button>
</form>        </li>

      </ul>
    </div>
  </footer>
  
  <script async="async" crossorigin="anonymous" src="https://assets-cdn.github.com/assets/mobile-f969dafa3896f77a5188d4e777cdce7fe7beba8bff2466b0ad82b39a47d9cdcd.js"></script>

  </body>
</html>
